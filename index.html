<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Foco TDAH</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configura√ß√£o do Tailwind para Dark Mode -->
    <script>
        tailwind.config = {
          darkMode: 'class', // Habilita o modo escuro baseado em classe (no <html>)
        }
    </script>
    
    <!-- Script de Carregamento do Tema (Evita "flash") -->
    <script>
      // Verifica se o usu√°rio j√° tem uma prefer√™ncia salva
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons (para √≠cones) -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <!-- Chart.js (Para os gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FullCalendar (Para Calend√°rio Avan√ßado) -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            writeBatch,
            getDocs,
            terminate 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VERS√ÉO DO APP ---
        const appVersion = "2.2.1 (Corre√ß√µes de UX e Calend√°rio)";
        // ---------------------

        // --- PASSO 1: COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        // COLE SUA CHAVE 'apiKey' SECRETA NA LINHA ABAIXO:
        const firebaseConfig = {
          apiKey: "AIzaSyBUG85P90L8eFjV3-rcI9X7G64v15JpVio", // <-- COLE SUA CHAVE AQUI
          authDomain: "meu-foco-pwa.firebaseapp.com",
          projectId: "meu-foco-pwa",
          storageBucket: "meu-foco-pwa.firebasestorage.app",
          messagingSenderId: "126519054955"
        };
        // ----------------------------------------------------
        
        // Objeto global para guardar inst√¢ncias dos gr√°ficos e calend√°rio
        window.myCharts = {};
        window.myCalendar = null;
        
        let db, auth, userId, appId;
        let dbPathPrefix = '';
        let currentUser = null; 
        let authError = null; 

        // Arrays para guardar os dados do Firestore
        let allRoutines = [];
        let routineHistory = [];
        let journalEntries = [];
        let allTasks = [];
        let allGoals = [];
        
        let unsubscribes = []; 

        // Estado da UI
        let authState = 'VERIFICANDO'; // 'VERIFICANDO', 'LOGADO', 'DESLOGADO'
        let currentPage = 'main'; // main, journalView, taskCalendar, progress
        let currentModal = null; // addRoutine, addTask, addGoal, settings, taskDetails
        let currentCalendarDate = new Date();
        let currentTheme = 'light'; // 'light' ou 'dark'
        let selectedTask = null; // Guarda a tarefa clicada no calend√°rio
        
        // --- Fonte √önica de Verdade para "Hoje" (BASEADO NO LOCAL) ---
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); 

        function getLocalYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        let todayString = getLocalYYYYMMDD(todayDate);
        let todayFullDate = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
        // --- Fim da Fonte de Verdade ---


        // --- PWA (Manifest & Service Worker) ---
        
        // 1. Manifesto (inline)
        const manifest = {
            "name": "Foco TDAH",
            "short_name": "Foco",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f1f5f9", // bg-slate-100
            "theme_color": "#0ea5e9", // bg-sky-500
            "description": `Seu assistente pessoal para rotinas, tarefas e foco. v${appVersion}`,
            "icons": [
                { "src": "https://placehold.co/192x192/0ea5e9/white?text=Foco&font=sans-serif", "type": "image/png", "sizes": "192x192" },
                { "src": "https://placehold.co/512x512/0ea5e9/white?text=Foco&font=sans-serif", "type": "image/png", "sizes": "512x512" }
            ]
        };
        const manifestString = JSON.stringify(manifest);
        const manifestUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(manifestString);
        document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`);

        // 2. Service Worker (inline)
        const swScript = `
            const CACHE_NAME = 'foco-tdah-cache-v${appVersion}'; // Vers√£o do Cache
            const urlsToCache = [
                '/',
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js', 
                'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js', 
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js',
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js',
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js',
                'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap',
                'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2'
            ];

            // Limpa caches antigos
            self.addEventListener('activate', event => {
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.filter(cacheName => cacheName !== CACHE_NAME)
                                      .map(cacheName => caches.delete(cacheName))
                        );
                    })
                );
            });

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Cache aberto');
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            // L√ìGICA DE CACHE SIMPLIFICADA (s√≥ rede primeiro para o index)
            self.addEventListener('fetch', event => {
                if (event.request.mode === 'navigate') {
                    event.respondWith(
                        fetch(event.request).catch(() => caches.match(event.request))
                    );
                } else {
                     event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                }
            });
        `;
        const swUrl = 'data:application/javascript,' + encodeURIComponent(swScript);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('Service Worker v2.2.1 registrado', registration.scope))
                    .catch(error => console.error('Falha no registro do Service Worker', error));
            });
        }
        // --- FIM PWA ---


        // --- Inicializa√ß√£o ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Define o estado inicial do tema
            currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateChartColors(); // Configura as cores do Chart.js
            
            initializeAppFirebase();
            setupEventListeners();
            render(); // Renderiza o estado inicial (loading spinner)
        });

        // --- L√ìGICA DE LOGIN ---
        function setLoggedInState(user) {
            console.log("...setLoggedInState chamado com:", user ? user.email : "null");
            currentUser = user; 
            userId = user.uid;
            authState = 'LOGADO';
            dbPathPrefix = `/artifacts/${appId}/users/${userId}`;
            
            if (!db) {
                db = getFirestore(initializeApp(firebaseConfig));
            }
            
            loadAllData();
            render();
        }
        
        function setLoggedOutState(error) {
            console.log("...setLoggedOutState chamado");
            currentUser = null;
            userId = null;
            authState = 'DESLOGADO';
            authError = error; // Salva o erro, se houver
            clearAllData();
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            render();
        }

        async function initializeAppFirebase() {
            try {
                appId = firebaseConfig.projectId || 'default-app-id';

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "SUA_CHAVE_API_SECRETA_COLE_AQUI") {
                    console.error("Configura√ß√£o do Firebase n√£o encontrada.");
                    authError = { code: "local-config-error", message: "Chave API n√£o encontrada. Edite o arquivo HTML e cole sua chave API." };
                    authState = 'DESLOGADO';
                    render();
                    return;
                }

                console.log("Firebase inicializado. Verificando estado de autentica√ß√£o...");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                
                // L√≥gica de Popup (v1.8.0) - s√≥ checa sess√£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("‚úÖ Login via Sess√£o:", user.email);
                        setLoggedInState(user);
                    } else {
                        console.log("‚ùå Deslogado.");
                        setLoggedOutState(null);
                    }
                    setupAuthListener(); // Configura o listener para logout futuro
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                setLoggedOutState(error);
            }
        }
        
        // Listener para mudan√ßas futuras (principalmente logout)
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (!user && authState === 'LOGADO') {
                    // Usu√°rio acabou de deslogar
                    console.log("üîÑ Evento de Logout detectado.");
                    setLoggedOutState(null);
                }
            });
        }
        
        // --- FUN√á√ïES DE LOGIN / LOGOUT ---
        
        async function handleGoogleLogin() {
            authError = null; // Limpa erros antigos
            render(); 
        
            const provider = new GoogleAuthProvider();
            try {
                console.log("handleGoogleLogin: Iniciando signInWithPopup...");
                const result = await signInWithPopup(auth, provider);
                
                if (result) {
                    console.log("‚úÖ Login via Popup:", result.user.email);
                    setLoggedInState(result.user);
                } else {
                    console.warn('Popup fechado sem login.');
                    // N√£o faz nada, continua deslogado
                }
            } catch (error) {
                console.error("Erro ao logar com Popup", error.code, error.message);
                setLoggedOutState(error);
            }
        }
        
        async function handleLogout() {
            try {
                unsubscribes.forEach(unsub => unsub());
                unsubscribes = [];
                
                if (db) {
                    await terminate(db);
                    db = null; 
                }
                
                await signOut(auth);
                // O 'onAuthStateChanged' (configurado em setupAuthListener)
                // vai pegar o evento de logout e chamar setLoggedOutState.
                
            } catch (error) {
                console.error("Erro ao fazer logout", error.message);
            }
        }
        
        function clearAllData() {
            allRoutines = [];
            routineHistory = [];
            journalEntries = [];
            allTasks = [];
            allGoals = [];
        }

        // --- FUN√á√ïES DE TEMA ---
        function setTheme(theme) {
            currentTheme = theme;
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            }
            updateChartColors();
            renderThemeToggle(); // Atualiza o bot√£o no modal de settings
            if (currentPage === 'progress') {
                renderAllCharts(); // Redesenha os gr√°ficos com as novas cores
            }
            if (currentPage === 'taskCalendar') {
                 // Destr√≥i e recria o calend√°rio para aplicar o tema
                 if (window.myCalendar) {
                    window.myCalendar.destroy();
                 }
                 initializeFullCalendar();
            }
        }
        
        function updateChartColors() {
             if (typeof Chart === 'undefined') return;
             const isDark = document.documentElement.classList.contains('dark');
             Chart.defaults.color = isDark ? '#94a3b8' : '#334155'; // slate-400 / slate-700
             Chart.defaults.borderColor = isDark ? '#334155' : '#e2e8f0'; // slate-700 / slate-200
        }

        function renderThemeToggle(containerId = 'theme-toggle-container') {
             const container = document.getElementById(containerId);
             if (!container) return;
             
             const isDark = document.documentElement.classList.contains('dark');
             container.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <span class="text-lg text-slate-700 dark:text-slate-200">Modo Escuro</span>
                    <button id="theme-toggle-button" data-action="toggle-theme" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${isDark ? 'bg-sky-500' : 'bg-slate-600'}">
                        <span id="theme-toggle-knob" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${isDark ? 'translate-x-5' : 'translate-x-1'}"></span>
                    </button>
                </div>
             `;
        }
        // --- FIM FUN√á√ïES DE TEMA ---


        // --- Carregamento de Dados (Firestore) ---

        function loadAllData() {
            if (!userId || !dbPathPrefix) {
                console.warn("loadAllData chamado sem userId ou dbPathPrefix. Abortando.");
                return;
            }
            console.log("Carregando dados de:", dbPathPrefix);
            
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];

            if (!db) {
                console.log("...loadAllData: DB n√£o encontrado, reinicializando...");
                db = getFirestore(initializeApp(firebaseConfig));
            }
            
            const routinesQuery = collection(db, `${dbPathPrefix}/routines`);
            const unsubRoutines = onSnapshot(routinesQuery, (snapshot) => {
                allRoutines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Rotinas carregadas:", allRoutines.length);
                if (auth.currentUser) render(); 
            }, (error) => console.error("Erro ao carregar rotinas:", error)); 
            unsubscribes.push(unsubRoutines); 

            const historyQuery = collection(db, `${dbPathPrefix}/routineHistory`);
            const unsubHistory = onSnapshot(historyQuery, (snapshot) => {
                routineHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar hist√≥rico:", error));
            unsubscribes.push(unsubHistory);

            const journalQuery = collection(db, `${dbPathPrefix}/journalEntries`);
            const unsubJournal = onSnapshot(journalQuery, (snapshot) => {
                journalEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar di√°rio:", error));
            unsubscribes.push(unsubJournal);

            const tasksQuery = collection(db, `${dbPathPrefix}/tasks`);
            const unsubTasks = onSnapshot(tasksQuery, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Tarefas carregadas:", allTasks.length);
                if (auth.currentUser) render();
                
                // --- CORRE√á√ÉO DO CALEND√ÅRIO ---
                // Se a p√°gina do calend√°rio estiver ativa, a *render() principal*
                // vai chamar o initializeFullCalendar().
                // Se j√° estivermos l√°, apenas atualizamos os eventos.
                if (currentPage === 'taskCalendar' && window.myCalendar) {
                    initializeFullCalendar(); // Recarrega os eventos
                }
            }, (error) => console.error("Erro ao carregar tarefas:", error));
            unsubscribes.push(unsubTasks);

            const goalsQuery = collection(db, `${dbPathPrefix}/goals`);
            const unsubGoals = onSnapshot(goalsQuery, (snapshot) => {
                allGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar objetivos:", error));
            unsubscribes.push(unsubGoals);
        }

        // --- Fun√ß√µes de Renderiza√ß√£o (UI) ---

        function render() {
            const appContainer = document.getElementById('app-container');
            const header = document.getElementById('main-header');
            const bottomNav = document.getElementById('bottom-nav');
            
            if (!appContainer || !header || !bottomNav) return;
            
            // --- L√ìGICA DE RENDERIZA√á√ÉO ATUALIZADA ---
            switch(authState) {
                case 'VERIFICANDO':
                    // Mostra spinner
                    header.classList.add('hidden');
                    bottomNav.classList.add('hidden');
                    appContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
                            <p class="text-slate-600 dark:text-slate-400 text-xl mt-6 font-semibold">Verificando login...</p>
                        </div>`;
                    break;
                
                case 'DESLOGADO':
                    // Mostra tela de login
                    header.classList.add('hidden');
                    bottomNav.classList.add('hidden');
                    appContainer.innerHTML = renderLoginScreen();
                    break;
                
                case 'LOGADO':
                    // Mostra o app normal
                    header.classList.remove('hidden');
                    bottomNav.classList.remove('hidden'); 
                
                    const headerTitle = document.getElementById('header-title');
                    
                    switch (currentPage) {
                        case 'main':
                            if(headerTitle) headerTitle.innerText = "Painel Principal";
                            appContainer.innerHTML = renderMainDashboard();
                            renderTodayJournalEntry(); 
                            break;
                        case 'journalView':
                            if(headerTitle) headerTitle.innerText = "Meu Di√°rio";
                            appContainer.innerHTML = renderJournalView();
                            break;
                        case 'taskCalendar':
                            if(headerTitle) headerTitle.innerText = "Calend√°rio";
                            appContainer.innerHTML = renderTaskCalendar();
                            // Renderiza o calend√°rio DEPOIS que o HTML (canvas) est√° na p√°gina
                            initializeFullCalendar();
                            break;
                        case 'progress':
                            if(headerTitle) headerTitle.innerText = "Meu Progresso";
                            appContainer.innerHTML = renderProgressPage();
                            // Renderiza os gr√°ficos DEPOIS que o HTML (canvas) est√° na p√°gina
                            renderAllCharts();
                            break;
                    }
                    renderBottomNav(); // Atualiza o estado ativo da tab bar
                    break;
            }
            // --- FIM DA L√ìGICA CONDICIONAL ---
            
            renderModal();
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function renderLoginScreen() {
             let errorMessage = '';
             if (authError) {
                 if (authError.code === 'auth/unauthorized-domain') {
                     errorMessage = "ERRO: O dom√≠nio `fabioyshiaki.github.io` n√£o est√° na lista de 'Dom√≠nios autorizados' no seu painel do Firebase.";
                 } else if (authError.code === 'auth/operation-not-allowed') {
                     errorMessage = "ERRO: O login com 'Google' est√° desativado no seu painel do Firebase.";
                 } else if (authError.code === 'local-config-error') {
                     errorMessage = `ERRO: ${authError.message}`;
                 } else {
                     errorMessage = `Erro: ${authError.message} (c√≥digo: ${authError.code})`;
                 }
             }
        
             return `
                <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                    <i data-lucide="brain" class="w-24 h-24 text-sky-500 mb-6"></i>
                    <h1 class="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-3">Bem-vindo ao Foco TDAH</h1>
                    <p class="text-xl text-slate-600 dark:text-slate-300 mb-10 max-w-md">Para salvar seus dados e sincronizar entre dispositivos, fa√ßa o login.</p>
                    <button id="google-login-btn" class="flex items-center justify-center space-x-3 w-full max-w-sm bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-lg font-semibold py-4 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.108-11.283-7.446l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.712 34.421 44 28.134 44 20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        <span>Entrar com Google</span>
                    </button>
                    <!-- Local para mostrar erros de login -->
                    <p id="auth-error-message" class="text-red-600 font-bold mt-6 text-lg max-w-sm">${errorMessage}</p>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-10">Vers√£o: ${appVersion}</p>
                </div>
            `;
        }

        function renderMainDashboard() {
            if (authState !== 'LOGADO') { 
                return `
                    <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
                        <p class="text-slate-600 dark:text-slate-400 text-xl mt-6 font-semibold">Carregando...</p>
                    </div>`;
            }
        
            return `
                <div class="p-4 flex flex-col gap-6">
                    <!-- Data -->
                    <div class="text-center">
                        <p id="header-date" class="text-sm text-slate-500 dark:text-slate-400 font-medium">${todayFullDate}</p>
                    </div>
                
                    <!-- 1. Rotinas Di√°rias (Layout de Coluna √önica) -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Rotinas</h2>
                            <button data-action="open-modal" data-modal="addRoutine" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="routines-list" class="space-y-3">
                            ${renderTodayRoutines()}
                        </div>
                    </div>

                    <!-- 2. Pr√≥ximas Tarefas -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Pr√≥ximas Tarefas</h2>
                            <button data-action="open-modal" data-modal="addTask" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="tasks-list" class="space-y-3">
                            ${renderUpcomingTasks()}
                        </div>
                    </div>

                    <!-- 3. Di√°rio -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-4">Di√°rio de Hoje</h2>
                        <textarea id="journal-textarea" class="w-full h-36 p-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 dark:placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors" placeholder="Como foi o seu dia?"></textarea>
                        <button id="save-journal-btn" class="mt-4 w-full bg-sky-600 text-white text-lg font-bold py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Di√°rio
                        </button>
                    </div>

                    <!-- 4. Objetivos (DE VOLTA!) -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Objetivos</h2>
                            <button data-action="open-modal" data-modal="addGoal" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="goals-list" class="space-y-3">
                            ${renderActiveGoals()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTodayRoutines() {
            if (allRoutines.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhuma rotina criada. Adicione uma no bot√£o '+' acima.</p>`;
            }
            return allRoutines.map(routine => {
                const historyEntry = routineHistory.find(h => h.routineId === routine.id && h.date === todayString);
                const isCompleted = historyEntry?.completed || false;
                
                return `
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                        <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                            <input type="checkbox" 
                                   class="form-checkbox h-7 w-7 text-sky-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-sky-500" 
                                   ${isCompleted ? 'checked' : ''}
                                   data-action="toggle-routine"
                                   data-routine-id="${routine.id}"
                                   data-routine-name="${routine.name}"
                                   data-history-id="${historyEntry?.id || ''}">
                            <span class="${isCompleted ? 'line-through text-slate-400 dark:text-slate-500' : ''}">${routine.name}</span>
                        </label>
                        <button data-action="delete-routine" data-id="${routine.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // --- L√ìGICA DE TAREFAS ATUALIZADA (v2.2.0) ---
        function renderUpcomingTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const sevenDaysFromNow = new Date(today);
            sevenDaysFromNow.setDate(today.getDate() + 7);

            const upcomingTasks = allTasks.filter(task => {
                const [year, month, day] = task.date.split('-').map(Number);
                const taskDate = new Date(year, month - 1, day);
                return taskDate >= today && taskDate <= sevenDaysFromNow;
            });

            // Ordena por data (mais pr√≥xima primeiro)
            upcomingTasks.sort((a, b) => a.date.localeCompare(b.date));

            if (upcomingTasks.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhuma tarefa para os pr√≥ximos 7 dias. Adicione uma no bot√£o '+' acima.</p>`;
            }
            
            return upcomingTasks.map(task => {
                const daysRemaining = getDaysRemaining(task.date);
                const isCompleted = task.completed;
                
                let colorClass = '';
                let daysText = '';

                if (daysRemaining >= 5) { // 7, 6, 5 dias
                    colorClass = 'bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-800 dark:text-emerald-200 dark:border-emerald-700';
                } else if (daysRemaining >= 2) { // 4, 3, 2 dias
                    colorClass = 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-800 dark:text-orange-200 dark:border-orange-700';
                } else { // 1, 0 dias
                    colorClass = 'bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-800 dark:text-rose-200 dark:border-rose-700';
                }
                
                if (isCompleted) {
                     colorClass = 'bg-slate-100 text-slate-400 border-slate-200 dark:bg-slate-600 dark:text-slate-400 dark:border-slate-500';
                }

                if (daysRemaining === 0) {
                    daysText = 'Hoje';
                } else if (daysRemaining === 1) {
                    daysText = '1 dia';
                } else {
                    daysText = `${daysRemaining} dias`;
                }

                return `
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg ${isCompleted ? 'opacity-60' : ''}">
                        <span class="text-xl text-slate-800 dark:text-slate-100 ${isCompleted ? 'line-through' : ''}">${task.name}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-sm px-2.5 py-0.5 rounded-full border ${colorClass}">
                                ${daysText}
                            </span>
                            <button data-action="toggle-task" data-id="${task.id}" data-completed="${isCompleted}" class="${isCompleted ? 'text-slate-400 hover:text-slate-600' : 'text-emerald-500 hover:text-emerald-700'} transition-colors">
                                <i data-lucide="${isCompleted ? 'check-circle' : 'circle'}" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActiveGoals() {
            const activeGoals = allGoals.filter(goal => !goal.completed);
            if (activeGoals.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhum objetivo ativo. Adicione um no bot√£o '+' acima.</p>`;
            }
            return activeGoals.map(goal => `
                <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                    <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                        <input type="checkbox" 
                               class="form-checkbox h-7 w-7 text-emerald-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-emerald-500"
                               data-action="complete-goal"
                               data-id="${goal.id}"
                               data-name="${goal.name}">
                        <span>${goal.name}</span>
                    </label>
                    <button data-action="delete-goal" data-id="${goal.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function renderTodayJournalEntry() {
            const journalTextarea = document.getElementById('journal-textarea');
            if (journalTextarea) {
                const todayEntry = journalEntries.find(entry => entry.id === todayString);
                journalTextarea.value = todayEntry ? todayEntry.text : '';
            }
        }

        // --- Renderiza√ß√£o das P√°ginas do Menu ---
        
        // --- P√ÅGINA DE PROGRESSO (v2.1.0) ---
        function renderProgressPage() {
            return `
                <div class="p-4 flex flex-col gap-6">
                    ${renderRoutineCharts()}
                    ${renderGoalStats()}
                </div>
            `;
        }

        // --- P√ÅGINA DE ESTAT√çSTICAS COM GR√ÅFICOS (v2.0.0) ---
        function renderRoutineCharts() {
            // Esta fun√ß√£o agora apenas desenha os containers dos gr√°ficos
            return `
                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-6">Estat√≠sticas de Rotinas</h2>
                    <div class="space-y-8">
                        
                        <!-- Gr√°fico de Hoje -->
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Hoje</h3>
                            <div class="h-64 flex items-center justify-center">
                                <canvas id="todayChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico da Semana -->
                        <div>
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">√öltimos 7 Dias</h3>
                            <div class="h-64">
                                <canvas id="weekChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico do M√™s -->
                        <div>
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">√öltimas 4 Semanas</h3>
                            <div class="h-64">
                                <canvas id="monthChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico do Ano -->
                        <div>
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Este Ano</h3>
                            <div class="h-64">
                                <canvas id="yearChart"></canvas>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // --- NOVAS FUN√á√ïES DE GR√ÅFICOS ---
        
        function renderAllCharts() {
            if (typeof Chart === 'undefined') {
                 console.error("Chart.js n√£o foi carregado.");
                 return;
            }
            // Limpa gr√°ficos antigos
            Object.values(window.myCharts).forEach(chart => chart.destroy());
            window.myCharts = {};
            
            renderTodayChart();
            renderWeekChart();
            renderMonthChart();
            renderYearChart();
        }
        
        function renderTodayChart() {
            const ctx = document.getElementById('todayChart')?.getContext('2d');
            if (!ctx) return;

            const todayEntries = routineHistory.filter(h => h.date === todayString);
            const completed = todayEntries.filter(h => h.completed).length;
            const total = allRoutines.length;
            const pending = total - completed;

            window.myCharts.todayChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Conclu√≠das', 'Pendentes'],
                    datasets: [{
                        data: [completed, pending < 0 ? 0 : pending],
                        backgroundColor: [
                            '#0ea5e9', // sky-500
                            document.documentElement.classList.contains('dark') ? '#334155' : '#e2e8f0' // slate-700 / slate-200
                        ],
                        borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff', // bg-slate-800 ou bg-white
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20
                            }
                        }
                    }
                }
            });
        }
        
        function renderWeekChart() {
            const ctx = document.getElementById('weekChart')?.getContext('2d');
            if (!ctx) return;

            const labels = [];
            const data = [];
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const totalRoutines = allRoutines.length > 0 ? allRoutines.length : 1; // Evita divis√£o por zero

            for (let i = 6; i >= 0; i--) {
                const date = new Date(todayDate);
                date.setDate(date.getDate() - i);
                
                const dateString = getLocalYYYYMMDD(date);
                const dayLabel = dayNames[date.getDay()];
                labels.push(dayLabel);
                
                const completed = routineHistory.filter(h => h.date === dateString && h.completed).length;
                const percentage = (completed / totalRoutines) * 100;
                data.push(percentage);
            }

            window.myCharts.weekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: data,
                        backgroundColor: '#0ea5e9', // sky-500
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function renderMonthChart() {
            const ctx = document.getElementById('monthChart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = ['Sem 4', 'Sem 3', 'Sem 2', 'Sem 1 (Atual)'];
            const data = [];
            const totalRoutines = allRoutines.length > 0 ? allRoutines.length : 1;

            for (let w = 3; w >= 0; w--) {
                const weekStart = new Date(todayDate);
                weekStart.setDate(weekStart.getDate() - (w * 7) - todayDate.getDay()); // In√≠cio da semana (Dom)
                
                let completedCount = 0;
                let dayCount = 0;
                
                for (let d = 0; d < 7; d++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + d);
                    const dateString = getLocalYYYYMMDD(date);
                    
                    // S√≥ conta dias at√© "hoje"
                    if (date <= todayDate) {
                        const entries = routineHistory.filter(h => h.date === dateString && h.completed);
                        completedCount += entries.length;
                        dayCount++;
                    }
                }
                
                const totalPossible = dayCount * totalRoutines;
                const percentage = totalPossible > 0 ? (completedCount / totalPossible) * 100 : 0;
                data.push(percentage);
            }

            window.myCharts.monthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: data,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function renderYearChart() {
            const ctx = document.getElementById('yearChart')?.getContext('2d');
            if (!ctx) return;

            const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const data = Array(12).fill(0);
            const daysInMonth = Array(12).fill(0).map((_, i) => new Date(todayDate.getFullYear(), i + 1, 0).getDate());
            const totalRoutines = allRoutines.length > 0 ? allRoutines.length : 1;
            const currentYear = todayDate.getFullYear();
            const currentMonth = todayDate.getMonth();

            const yearEntries = routineHistory.filter(h => h.date.startsWith(currentYear));

            yearEntries.forEach(h => {
                const month = parseInt(h.date.split('-')[1], 10) - 1; // 0-11
                if (h.completed) {
                    data[month]++;
                }
            });
            
            // Calcula porcentagem
            const percentageData = data.map((completedCount, month) => {
                let totalDaysInMonth = daysInMonth[month];
                if(month === currentMonth) {
                    totalDaysInMonth = todayDate.getDate();
                }
                if (month > currentMonth) {
                    totalDaysInMonth = 0;
                }
                
                const totalPossible = totalDaysInMonth * totalRoutines;
                return totalPossible > 0 ? (completedCount / totalPossible) * 100 : 0;
            });

            window.myCharts.yearChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: percentageData,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }


        // --- DI√ÅRIO COM ACORDE√ÉO (v2.0.0) ---
        function renderJournalView() {
            const entriesByMonth = {};
            journalEntries.forEach(entry => {
                const [year, month] = entry.id.split('-'); // YYYY-MM-DD
                const monthKey = `${year}-${month}`;
                if (!entriesByMonth[monthKey]) {
                    entriesByMonth[monthKey] = [];
                }
                entriesByMonth[monthKey].push(entry);
            });

            const sortedMonths = Object.keys(entriesByMonth).sort().reverse();
            
            let html = `<div class="p-4 flex flex-col gap-4">`;

            if (sortedMonths.length === 0) {
                 html += `<p class="text-slate-500 dark:text-slate-400 text-center mt-8 text-lg">Nenhuma entrada no di√°rio ainda.</p>`;
            }

            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                html += `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
                            <button data-action="toggle-month" data-month-id="month-${monthKey}" class="w-full flex justify-between items-center p-6">
                                <h3 class="text-2xl font-semibold text-sky-700 dark:text-sky-500 capitalize">${monthName}</h3>
                                <i data-lucide="chevron-down" class="text-slate-500 transition-transform"></i>
                            </button>
                            <div id="month-${monthKey}" class="hidden space-y-5 px-6 pb-6 pt-2 border-t border-slate-200 dark:border-slate-700">`;
                
                entriesByMonth[monthKey].sort((a, b) => b.id.localeCompare(a.id)).forEach(entry => {
                    const [y, m, d] = entry.id.split('-').map(Number);
                    const entryDate = new Date(y, m - 1, d).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
                    html += `
                        <div class="border-b border-slate-200 dark:border-slate-700 pb-4 last:border-b-0">
                            <p class="text-lg font-semibold text-slate-800 dark:text-slate-100">${entryDate}</p>
                            <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap mt-1">${entry.text}</p>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            html += `</div>`;
            return html;
        }

        // --- CALEND√ÅRIO AVAN√áADO (v2.2.0) ---
        function renderTaskCalendar() {
            // Apenas o container. O FullCalendar ser√° inicializado depois.
            return `
                <div id="calendar-container" class="p-4">
                    <div id="calendar" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-4">
                        <!-- FullCalendar ser√° renderizado aqui -->
                    </div>
                </div>
            `;
        }
        
        function initializeFullCalendar() {
            if (typeof FullCalendar === 'undefined') {
                 console.error("FullCalendar n√£o foi carregado.");
                 return;
            }
            
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;
            
            // Destr√≥i o calend√°rio antigo antes de desenhar um novo
            if (window.myCalendar) {
                window.myCalendar.destroy();
            }
            
            // Formata as tarefas para o FullCalendar
            const formattedTasks = allTasks.map(task => ({
                id: task.id,
                title: task.name,
                start: task.date,
                allDay: true,
                // Adiciona classes customizadas
                className: task.completed 
                    ? 'fc-event-completed' 
                    : 'fc-event-pending',
                extendedProps: {
                    completed: task.completed,
                    name: task.name
                }
            }));
            
            const isDark = document.documentElement.classList.contains('dark');

            window.myCalendar = new FullCalendar.Calendar(calendarEl, {
                plugins: [ FullCalendar.dayGridPlugin, FullCalendar.timeGridPlugin, FullCalendar.listPlugin ], // Carrega os plugins
                initialView: 'dayGridMonth',
                locale: 'pt-br', // Tradu√ß√£o
                buttonText: { // Tradu√ß√£o dos bot√µes
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia',
                    list: 'Lista'
                },
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: formattedTasks,
                // --- A√ß√£o de clique para excluir/desmarcar ---
                eventClick: (info) => {
                    const taskId = info.event.id;
                    const task = allTasks.find(t => t.id === taskId);
                    if (task) {
                        selectedTask = task; // Salva a tarefa selecionada
                        currentModal = 'taskDetails'; // Abre o novo modal
                        renderModal();
                    }
                }
            });
            
            window.myCalendar.render();
        }
        
        // --- P√ÅGINA DE OBJETIVOS (v2.1.0) ---
        function renderGoalStats() {
            const activeGoals = allGoals.filter(goal => !goal.completed);
            const completedGoals = allGoals.filter(goal => goal.completed);

            return `
                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Objetivos</h2>
                        <button data-action="open-modal" data-modal="addGoal" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                            <i data-lucide="plus-circle" class="w-7 h-7"></i>
                        </button>
                    </div>
                    
                    <!-- Objetivos Ativos -->
                    <div>
                        <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Ativos</h3>
                        <div class="space-y-4">
                            ${activeGoals.length > 0 ? activeGoals.map(goal => `
                                <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                                    <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                                        <input type="checkbox" 
                                               class="form-checkbox h-7 w-7 text-emerald-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-emerald-500"
                                               data-action="complete-goal"
                                               data-id="${goal.id}"
                                               data-name="${goal.name}">
                                        <span>${goal.name}</span>
                                    </label>
                                    <button data-action="delete-goal" data-id="${goal.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            `).join('') : `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum objetivo ativo.</p>`}
                        </div>
                    </div>
                    
                    <!-- Objetivos Conclu√≠dos -->
                    <div class="mt-8">
                        <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Conclu√≠dos</h3>
                        <div class="space-y-4">
                            ${completedGoals.length > 0 ? completedGoals.map(goal => `
                                <p class="text-xl text-slate-400 dark:text-slate-500 line-through p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg">${goal.name}</p>
                            `).join('') : `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum objetivo conclu√≠do ainda.</p>`}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- NOVO: Renderiza a Tab Bar ---
        function renderBottomNav() {
            const nav = document.getElementById('bottom-nav');
            if (!nav) return;
            
            const tabs = [
                { id: 'main', icon: 'layout-dashboard', label: 'In√≠cio' },
                { id: 'journalView', icon: 'book-open', label: 'Di√°rio' },
                { id: 'taskCalendar', icon: 'calendar-days', label: 'Calend√°rio' },
                { id: 'progress', icon: 'pie-chart', label: 'Progresso' }
            ];
            
            nav.innerHTML = tabs.map(tab => {
                const isActive = currentPage === tab.id;
                const activeClass = isActive ? 'text-sky-500 dark:text-sky-400' : 'text-slate-500 dark:text-slate-400';
                return `
                    <button data-action="nav-${tab.id}" class="flex flex-col items-center justify-center p-2 w-full ${activeClass} transition-colors">
                        <i data-lucide="${tab.icon}" class="w-6 h-6"></i>
                        <span class="text-xs font-semibold">${tab.label}</span>
                    </button>
                `;
            }).join('');
        }

        // --- Renderiza√ß√£o do Modal ---

        function renderModal() {
            const modalContainer = document.getElementById('modal-container');
            if (!currentModal) {
                selectedTask = null; // Limpa a tarefa selecionada
                modalContainer.innerHTML = '';
                return;
            }

            let modalTitle = '';
            let modalContent = '';

            switch (currentModal) {
                case 'addRoutine':
                    modalTitle = 'Nova Rotina Di√°ria';
                    modalContent = `
                        <label for="routine-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome da Rotina</label>
                        <input type="text" id="routine-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Tomar caf√© da manh√£">
                        <button id="save-routine-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Rotina
                        </button>
                    `;
                    break;
                case 'addTask':
                    modalTitle = 'Nova Tarefa Agendada';
                    modalContent = `
                        <label for="task-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome da Tarefa</label>
                        <input type="text" id="task-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Consulta m√©dica">
                        
                        <label for="task-date" class="block text-lg font-medium text-slate-700 dark:text-slate-200 mt-4">Data</label>
                        <input type="date" id="task-date" value="${todayString}" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        
                        <button id="save-task-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Tarefa
                        </button>
                    `;
                    break;
                case 'addGoal':
                    modalTitle = 'Novo Objetivo';
                    modalContent = `
                        <label for="goal-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome do Objetivo</label>
                        <input type="text" id="goal-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Ler 1 livro este m√™s">
                        <button id="save-goal-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Objetivo
                        </button>
                    `;
                    break;
                case 'settings':
                    modalTitle = 'Configura√ß√µes';
                    modalContent = `
                        <div class="space-y-6">
                            <!-- Status do Usu√°rio -->
                            <div>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Usu√°rio Logado</p>
                                <p class="text-lg font-semibold text-slate-800 dark:text-slate-100">${currentUser ? (currentUser.displayName || currentUser.email) : 'Deslogado'}</p>
                            </div>
                            
                            <!-- Bot√£o de Tema -->
                            <div id="theme-toggle-container-modal">
                                <!-- O bot√£o de tema ser√° renderizado aqui -->
                            </div>
                            
                            <!-- Bot√£o de Sair -->
                            <div>
                                <a href="#" data-action="auth-logout" class="flex items-center justify-center space-x-3 w-full bg-rose-600 text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-rose-700">
                                    <i data-lucide="log-out" class="w-5 h-5"></i>
                                    <span>Sair (Logout)</span>
                                </a>
                            </div>
                            
                            <!-- Vers√£o do App -->
                            <p class="text-center text-sm text-slate-400 dark:text-slate-500">Vers√£o: ${appVersion}</p>
                        </div>
                    `;
                    break;
                // --- NOVO MODAL DE DETALHES DA TAREFA ---
                case 'taskDetails':
                    if (!selectedTask) {
                        currentModal = null;
                        return;
                    }
                    modalTitle = 'Detalhes da Tarefa';
                    const isCompleted = selectedTask.completed;
                    const toggleButtonText = isCompleted ? 'Marcar como Pendente' : 'Concluir Tarefa';
                    const toggleButtonIcon = isCompleted ? 'x-circle' : 'check-circle';
                    const toggleButtonClass = isCompleted ? 'bg-slate-500 hover:bg-slate-600' : 'bg-emerald-600 hover:bg-emerald-700';
                    
                    modalContent = `
                        <div class="space-y-6">
                            <h4 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">${selectedTask.name}</h4>
                            <p class="text-lg text-slate-600 dark:text-slate-300 flex items-center">
                                <i data-lucide="calendar" class="inline-block w-5 h-5 mr-2"></i>
                                ${new Date(selectedTask.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' })}
                            </p>
                            
                            <!-- Bot√£o de (Des)Marcar -->
                            <button data-action="toggle-task" data-id="${selectedTask.id}" data-completed="${isCompleted}" class="${toggleButtonClass} flex items-center justify-center space-x-3 w-full text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">
                                <i data-lucide="${toggleButtonIcon}" class="w-5 h-5"></i>
                                <span>${toggleButtonText}</span>
                            </button>
                            
                            <!-- Bot√£o de Excluir -->
                            <button data-action="delete-task" data-id="${selectedTask.id}" class="flex items-center justify-center space-x-3 w-full bg-rose-600 text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-rose-700">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <span>Excluir Tarefa</span>
                            </button>
                        </div>
                    `;
                    break;
            }

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-40" data-action="close-modal"></div>
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-2xl shadow-2xl">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-3xl font-bold text-slate-800 dark:text-slate-100">${modalTitle}</h3>
                            <button data-action="close-modal" class="text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300">
                                <i data-lucide="x" class="w-8 h-8"></i>
                            </button>
                        </div>
                        <div>
                            ${modalContent}
                        </div>
                    </div>
                </div>
            `;
            
            // Renderiza o bot√£o de tema *dentro* do modal
            if (currentModal === 'settings') {
                renderThemeToggle('theme-toggle-container-modal');
            }
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- Navega√ß√£o e Event Listeners ---
        
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                
                // Listener do Bot√£o de Login
                if (e.target.closest('#google-login-btn')) {
                    handleGoogleLogin();
                    return;
                }
                
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                
                // A√ß√£o de Logout
                if (action === 'auth-logout') {
                    currentModal = null; // Fecha o modal de settings
                    handleLogout();
                    return;
                }
                
                // A√ß√£o de Mudar Tema
                if (action === 'toggle-theme') {
                    setTheme(currentTheme === 'light' ? 'dark' : 'light');
                    return;
                }
                
                // A√ß√£o de Acorde√£o do Di√°rio
                if (action === 'toggle-month') {
                    const monthId = target.dataset.monthId;
                    const content = document.getElementById(monthId);
                    const icon = target.querySelector('i');
                    if (content) content.classList.toggle('hidden');
                    if (icon) icon.classList.toggle('rotate-180');
                    return;
                }

                // A√ß√µes do Menu (agora Tab Bar)
                if (action.startsWith('nav-')) {
                    currentPage = action.split('-')[1];
                    render(); // Renderiza a nova p√°gina e atualiza a tab bar
                }
                
                // A√ß√£o do novo bot√£o de Configura√ß√µes
                if (action === 'open-settings') {
                    currentModal = 'settings';
                    renderModal();
                }

                // A√ß√µes do Modal
                if (action === 'open-modal') {
                    currentModal = target.dataset.modal;
                    renderModal();
                }
                if (action === 'close-modal') {
                    currentModal = null;
                    renderModal();
                }

                // A√ß√µes de Salvar (CRUD)
                if (action === 'save-routine') handleAddRoutine();
                if (action === 'save-task') handleAddTask();
                if (action === 'save-goal') handleAddGoal();
                if (action === 'save-journal') handleSaveJournal();

                // A√ß√µes de Itens (CRUD)
                if (action === 'toggle-routine') handleToggleRoutine(target);
                if (action === 'delete-routine') handleDeleteRoutine(target.dataset.id);
                if (action === 'toggle-task') handleToggleTask(target.dataset.id, target.dataset.completed === 'true'); // <-- MUDADO
                if (action === 'delete-task') handleDeleteTask(target.dataset.id); // <-- NOVO
                if (action === 'complete-goal') handleCompleteGoal(target); // <-- MUDADO
                if (action === 'delete-goal') handleDeleteGoal(target.dataset.id);
                
                // A√ß√µes do Calend√°rio
                if (action === 'calendar-prev') {
                    window.myCalendar?.prev();
                }
                if (action === 'calendar-next') {
                    window.myCalendar?.next();
                }
            });
            
            // Listener separado para os bot√µes de salvar (pois eles s√£o recriados)
            document.body.addEventListener('click', e => {
                if (e.target.id === 'save-journal-btn') {
                    handleSaveJournal();
                }
                if (e.target.id === 'save-routine-btn') {
                    handleAddRoutine();
                }
                if (e.target.id === 'save-task-btn') {
                    handleAddTask();
                }
                if (e.target.id === 'save-goal-btn') {
                    handleAddGoal();
                }
            });
        }
        
        // --- Fun√ß√µes de Manipula√ß√£o de Dados (CRUD) ---

        async function handleAddRoutine() {
            const input = document.getElementById('routine-name');
            const name = input.value.trim();
            if (name && userId) { 
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/routines`), {
                        name: name,
                        createdAt: new Date().toISOString()
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar rotina:", error);
                }
            } else if (!name) {
                console.warn("Nome da rotina est√° vazio.");
            } else if (!userId) {
                console.error("Usu√°rio n√£o autenticado. N√£o √© poss√≠vel salvar.");
            }
        }
        
        async function handleDeleteRoutine(routineId) {
            // Confirma√ß√£o j√° existe!
            showConfirmationModal("Tem certeza que deseja excluir esta rotina? Todo o hist√≥rico dela ser√° perdido.", async () => {
                if (!userId) return;
                try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/routines`, routineId));
                    
                    const historyQuery = query(collection(db, `${dbPathPrefix}/routineHistory`), where("routineId", "==", routineId));
                    const historySnapshot = await getDocs(historyQuery);
                    const batch = writeBatch(db);
                    historySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    console.log("Rotina e hist√≥rico deletados.");
                } catch (error) {
                    console.error("Erro ao deletar rotina:", error);
                }
            });
        }
        
        async function handleToggleRoutine(checkbox) {
            const { routineId, routineName, historyId } = checkbox.dataset;
            const isCompleted = checkbox.checked;

            if (!userId) return;

            try {
                const historyDocId = historyId || `${routineId}_${todayString}`;
                const historyDocRef = doc(db, `${dbPathPrefix}/routineHistory`, historyDocId);
                
                await setDoc(historyDocRef, {
                    routineId: routineId,
                    routineName: routineName,
                    date: todayString,
                    completed: isCompleted
                }, { merge: true }); 
                
            } catch (error) {
                console.error("Erro ao atualizar rotina:", error);
            }
        }
        
        async function handleSaveJournal() {
            const textarea = document.getElementById('journal-textarea');
            const text = textarea.value;
            if (userId) {
                try {
                    const journalDocRef = doc(db, `${dbPathPrefix}/journalEntries`, todayString);
                    await setDoc(journalDocRef, {
                        text: text,
                        lastUpdatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    const btn = document.getElementById('save-journal-btn');
                    btn.innerText = 'Salvo!';
                    btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
                    btn.classList.remove('bg-sky-600', 'hover:bg-sky-700');
                    setTimeout(() => {
                        btn.innerText = 'Salvar Di√°rio';
                        btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                        btn.classList.add('bg-sky-600', 'hover:bg-sky-700');
                    }, 2000);
                    
                } catch (error) {
                    console.error("Erro ao salvar di√°rio:", error);
                }
            }
        }
        
        async function handleAddTask() {
            const name = document.getElementById('task-name').value.trim();
            const date = document.getElementById('task-date').value;
            if (name && date && userId) {
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/tasks`), {
                        name: name,
                        date: date,
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar tarefa:", error);
                }
            }
        }
        
        // --- L√ìGICA DE TAREFA ATUALIZADA (v2.2.0) ---
        async function handleToggleTask(taskId, isCompleted) {
            if (!userId) return;
            
            try {
                const taskDocRef = doc(db, `${dbPathPrefix}/tasks`, taskId);
                await updateDoc(taskDocRef, {
                    completed: !isCompleted // Inverte o estado
                });
                
                // Fecha o modal de detalhes, se estiver aberto
                if (currentModal === 'taskDetails') {
                    currentModal = null;
                    renderModal();
                }
                // O listener onSnapshot vai atualizar a UI
            } catch (error) {
                console.error("Erro ao (des)marcar tarefa:", error);
            }
        }
        
        async function handleDeleteTask(taskId) {
            if (!userId) return;
            
            showConfirmationModal("Tem certeza que deseja excluir esta tarefa?", async () => {
                try {
                    const taskDocRef = doc(db, `${dbPathPrefix}/tasks`, taskId);
                    await deleteDoc(taskDocRef);
                    
                    // Fecha o modal de detalhes
                    currentModal = null;
                    renderModal();
                    // O listener onSnapshot vai atualizar a UI
                } catch (error) {
                    console.error("Erro ao excluir tarefa:", error);
                }
            });
        }
        
        async function handleAddGoal() {
            const input = document.getElementById('goal-name');
            const name = input.value.trim();
            if (name && userId) {
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/goals`), {
                        name: name,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar objetivo:", error);
                }
            }
        }
        
        // --- L√ìGICA DE OBJETIVO ATUALIZADA (v2.2.0) ---
        async function handleCompleteGoal(checkbox) {
             const goalId = checkbox.dataset.id;
             const goalName = checkbox.dataset.name;
             
             // 1. Imediatamente desmarca a caixa
             checkbox.checked = false; 
             
             if (!userId) return;

             // 2. Pede confirma√ß√£o
             showConfirmationModal(`Tem certeza que deseja marcar "${goalName}" como conclu√≠do? Ele ser√° removido da lista de ativos.`, () => {
                 // 3. Se confirmado, chama a l√≥gica real
                 confirmCompleteGoalLogic(goalId);
             });
        }
        
        async function confirmCompleteGoalLogic(goalId) {
             try {
                const goalDocRef = doc(db, `${dbPathPrefix}/goals`, goalId);
                await updateDoc(goalDocRef, {
                    completed: true,
                    completedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error("Erro ao completar objetivo:", error);
            }
        }
        
        async function handleDeleteGoal(goalId) {
            showConfirmationModal("Tem certeza que deseja excluir este objetivo?", async () => {
                if (!userId) return;
                 try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/goals`, goalId));
                } catch (error) {
                    console.error("Erro ao deletar objetivo:", error);
                }
            });
        }
        
        // --- Fun√ß√µes Auxiliares (Modal de Confirma√ß√£o) ---
        
        function getDaysRemaining(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const taskDate = new Date(year, month - 1, day); 
            
            const diffTime = taskDate.getTime() - todayDate.getTime();
            
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            return diffDays < 0 ? 0 : diffDays;
        }

        function showConfirmationModal(message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            const confirmationId = 'modal-confirm-' + Date.now();
            
            const modalHtml = `
                <div id="${confirmationId}" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" data-action="close-confirm"></div>
                    <div class="bg-white dark:bg-slate-800 w-full max-w-sm p-6 rounded-2xl shadow-2xl z-10">
                        <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 mb-4">Confirmar A√ß√£o</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-6 text-lg">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button data-action="close-confirm" class="px-5 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button data-action="confirm-action" class="px-5 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold transition-colors">
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
            
            const modalElement = document.getElementById(confirmationId);

            const handleConfirmationClick = (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                if (target.dataset.action === 'confirm-action') {
                    onConfirm();
                    modalElement.remove();
                }
                if (target.dataset.action === 'close-confirm') {
                    modalElement.remove();
                }
            };
            
            modalElement.addEventListener('click', handleConfirmationClick);
        }

    </script>

    <style>
        /* Estilo base */
        html.dark body {
            background-color: #0f172a; /* bg-slate-900 */
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Remove o spinner padr√£o de inputs[type=date] (opcional) */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        /* Cor do texto do input[type=date] no modo escuro */
        .dark input[type="date"] {
            color-scheme: dark;
        }

        /* Checkbox customizado */
        .form-checkbox {
            appearance: none;
            -webkit-appearance: none;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            border-width: 2px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        .form-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-position: center;
            background-repeat: no-repeat;
            background-size: 100% 100%;
        }
        .form-checkbox:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
             --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);
             box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
             --tw-ring-opacity: 0.5;
        }
        
        /* Estilos do FullCalendar para Dark Mode */
        .dark .fc {
            color: #cbd5e1; /* slate-300 */
        }
        .dark .fc-daygrid-day-frame, .dark .fc-col-header-cell, .dark .fc-list-table, .dark .fc-list-day-frame, .dark .fc-timegrid-slot-lane {
            background-color: #1e293b !important; /* slate-800 */
            border-color: #334155 !important; /* slate-700 */
        }
        .dark .fc-list-event:hover td {
            background-color: #334155 !important; /* slate-700 */
        }
        .dark .fc .fc-day-today {
            background-color: #1e293b !important; /* slate-800 */
        }
        .dark .fc .fc-toolbar-title {
            color: #f1f5f9; /* slate-100 */
        }
        .dark .fc .fc-button-primary {
            background-color: #334155; /* slate-700 */
            border-color: #475569; /* slate-600 */
            color: #f1f5f9; /* slate-100 */
        }
        .dark .fc .fc-button-primary:hover {
            background-color: #475569; /* slate-600 */
        }
        .dark .fc-event-pending {
            background-color: #0369a1 !important; /* sky-700 */
            border-color: #0ea5e9 !important; /* sky-500 */
        }
        .dark .fc-event-completed {
            background-color: #065f46 !important; /* emerald-800 */
            border-color: #10b981 !important; /* emerald-500 */
            opacity: 0.6;
        }
    </style>
</head>
<body class="antialiased font-sans bg-slate-100 dark:bg-slate-900">

    <!-- Conte√∫do Principal -->
    <div class="min-h-screen">
        <!-- Header Principal -->
        <header id="main-header" class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-10 border-b border-slate-200 dark:border-slate-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- T√≠tulo (agora √† esquerda) -->
                    <div class="text-center">
                        <h1 id="header-title" class="text-2xl font-bold text-slate-900 dark:text-slate-100">Painel Principal</h1>
                    </div>
                    
                    <!-- Bot√£o de Configura√ß√µes (novo) -->
                    <button id="settings-button" data-action="open-settings" class="text-slate-600 dark:text-slate-300 hover:text-sky-600 dark:hover:text-sky-400 transition-colors">
                        <i data-lucide="settings" class="w-7 h-7"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Container da P√°gina -->
        <!-- pb-24 = padding-bottom para deixar espa√ßo para a tab bar -->
        <main id="app-container" class="pb-24">
            <!-- O conte√∫do da p√°gina √© renderizado aqui pelo JavaScript -->
            <!-- Loading Spinner inicial -->
             <div class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
            </div>
        </main>
    </div>
    
    <!-- Container do Modal -->
    <div id="modal-container">
        <!-- O modal √© renderizado aqui pelo JavaScript -->
    </div>
    
    <!-- NOVA BARRA DE NAVEGA√á√ÉO INFERIOR (TAB BAR) -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex justify-around items-center shadow-lg z-10">
         <!-- As abas s√£o renderizadas aqui pelo JavaScript (renderBottomNav) -->
    </nav>

</body>
</html>

