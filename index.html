<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Foco TDAH</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configura√ß√£o do Tailwind para Dark Mode -->
    <script>
        tailwind.config = {
          darkMode: 'class', // Habilita o modo escuro baseado em classe (no <html>)
          theme: {
            extend: {
              // Voc√™ pode adicionar cores personalizadas aqui se quiser
            }
          }
        }
    </script>
    
    <!-- Script de Carregamento do Tema (Evita "flash") -->
    <script>
      // Verifica se o usu√°rio j√° tem uma prefer√™ncia salva
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons (para √≠cones) -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <!-- Chart.js (Para os gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            writeBatch,
            getDocs,
            terminate 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VERS√ÉO DO APP ---
        const appVersion = "2.0.0 (Gr√°ficos e Di√°rio v2)";
        // ---------------------

        // --- PASSO 1: COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        // COLE SUA CHAVE 'apiKey' SECRETA NA LINHA ABAIXO:
        const firebaseConfig = {
          apiKey: "AIzaSyBUG85P90L8eFjV3-rcI9X7G64v15JpVio", // <-- COLE SUA CHAVE AQUI
          authDomain: "meu-foco-pwa.firebaseapp.com",
          projectId: "meu-foco-pwa",
          storageBucket: "meu-foco-pwa.firebasestorage.app",
          messagingSenderId: "126519054955"
        };
        // ----------------------------------------------------
        
        // Objeto global para guardar inst√¢ncias dos gr√°ficos
        window.myCharts = {};
        
        let db, auth, userId, appId;
        let dbPathPrefix = '';
        let currentUser = null; 
        let authError = null; 

        // Arrays para guardar os dados do Firestore
        let allRoutines = [];
        let routineHistory = [];
        let journalEntries = [];
        let allTasks = [];
        let allGoals = [];
        
        let unsubscribes = []; 

        // Estado da UI
        let authState = 'VERIFICANDO'; // 'VERIFICANDO', 'LOGADO', 'DESLOGADO'
        let currentPage = 'main'; 
        let currentModal = null; 
        let currentCalendarDate = new Date();
        let currentTheme = 'light'; // 'light' ou 'dark'
        
        // --- Fonte √önica de Verdade para "Hoje" (BASEADO NO LOCAL) ---
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); 

        function getLocalYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        let todayString = getLocalYYYYMMDD(todayDate);
        let todayFullDate = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
        // --- Fim da Fonte de Verdade ---


        // --- PWA (Manifest & Service Worker) ---
        
        // 1. Manifesto (inline)
        const manifest = {
            "name": "Foco TDAH",
            "short_name": "Foco",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f1f5f9", // bg-slate-100
            "theme_color": "#0ea5e9", // bg-sky-500
            "description": `Seu assistente pessoal para rotinas, tarefas e foco. v${appVersion}`,
            "icons": [
                { "src": "https://placehold.co/192x192/0ea5e9/white?text=Foco&font=sans-serif", "type": "image/png", "sizes": "192x192" },
                { "src": "https://placehold.co/512x512/0ea5e9/white?text=Foco&font=sans-serif", "type": "image/png", "sizes": "512x512" }
            ]
        };
        const manifestString = JSON.stringify(manifest);
        const manifestUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(manifestString);
        document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`);

        // 2. Service Worker (inline)
        const swScript = `
            const CACHE_NAME = 'foco-tdah-cache-v${appVersion}'; // Vers√£o do Cache
            const urlsToCache = [
                '/',
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js', // <-- NOVO: Cachear Chart.js
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js',
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js',
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js',
                'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap',
                'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2'
            ];

            // Limpa caches antigos
            self.addEventListener('activate', event => {
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.filter(cacheName => cacheName !== CACHE_NAME)
                                      .map(cacheName => caches.delete(cacheName))
                        );
                    })
                );
            });

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Cache aberto');
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            // L√ìGICA DE CACHE SIMPLIFICADA (s√≥ rede primeiro para o index)
            self.addEventListener('fetch', event => {
                if (event.request.mode === 'navigate') {
                    event.respondWith(
                        fetch(event.request).catch(() => caches.match(event.request))
                    );
                } else {
                     event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                }
            });
        `;
        const swUrl = 'data:application/javascript,' + encodeURIComponent(swScript);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('Service Worker v2.0.0 registrado', registration.scope))
                    .catch(error => console.error('Falha no registro do Service Worker', error));
            });
        }
        // --- FIM PWA ---


        // --- Inicializa√ß√£o ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Define o estado inicial do tema
            currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateChartColors(); // Configura as cores do Chart.js
            
            initializeAppFirebase();
            setupEventListeners();
            render(); // Renderiza o estado inicial (loading spinner)
        });

        // --- L√ìGICA DE LOGIN ---
        function setLoggedInState(user) {
            console.log("...setLoggedInState chamado com:", user ? user.email : "null");
            currentUser = user; 
            userId = user.uid;
            authState = 'LOGADO';
            dbPathPrefix = `/artifacts/${appId}/users/${userId}`;
            
            if (!db) {
                db = getFirestore(initializeApp(firebaseConfig));
            }
            
            loadAllData();
            render();
        }
        
        function setLoggedOutState(error) {
            console.log("...setLoggedOutState chamado");
            currentUser = null;
            userId = null;
            authState = 'DESLOGADO';
            authError = error; // Salva o erro, se houver
            clearAllData();
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            render();
        }

        async function initializeAppFirebase() {
            try {
                appId = firebaseConfig.projectId || 'default-app-id';

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "SUA_CHAVE_API_SECRETA_COLE_AQUI") {
                    console.error("Configura√ß√£o do Firebase n√£o encontrada.");
                    authError = { code: "local-config-error", message: "Chave API n√£o encontrada. Edite o arquivo HTML e cole sua chave API." };
                    authState = 'DESLOGADO';
                    render();
                    return;
                }

                console.log("Firebase inicializado. Verificando estado de autentica√ß√£o...");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                
                // L√≥gica de Popup (v1.8.0) - s√≥ checa sess√£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("‚úÖ Login via Sess√£o:", user.email);
                        setLoggedInState(user);
                    } else {
                        console.log("‚ùå Deslogado.");
                        setLoggedOutState(null);
                    }
                    setupAuthListener(); // Configura o listener para logout futuro
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                setLoggedOutState(error);
            }
        }
        
        // Listener para mudan√ßas futuras (principalmente logout)
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (!user && authState === 'LOGADO') {
                    // Usu√°rio acabou de deslogar
                    console.log("üîÑ Evento de Logout detectado.");
                    setLoggedOutState(null);
                }
            });
        }
        
        // --- FUN√á√ïES DE LOGIN / LOGOUT ---
        
        async function handleGoogleLogin() {
            authError = null; // Limpa erros antigos
            render(); 
        
            const provider = new GoogleAuthProvider();
            try {
                console.log("handleGoogleLogin: Iniciando signInWithPopup...");
                const result = await signInWithPopup(auth, provider);
                
                if (result) {
                    console.log("‚úÖ Login via Popup:", result.user.email);
                    setLoggedInState(result.user);
                } else {
                    console.warn('Popup fechado sem login.');
                    setLoggedOutState(null);
                }
            } catch (error) {
                console.error("Erro ao logar com Popup", error.code, error.message);
                setLoggedOutState(error);
            }
        }
        
        async function handleLogout() {
            try {
                unsubscribes.forEach(unsub => unsub());
                unsubscribes = [];
                
                if (db) {
                    await terminate(db);
                    db = null; 
                }
                
                await signOut(auth);
                // O 'onAuthStateChanged' (configurado em setupAuthListener)
                // vai pegar o evento de logout e chamar setLoggedOutState.
                
            } catch (error) {
                console.error("Erro ao fazer logout", error.message);
            }
        }
        
        function clearAllData() {
            allRoutines = [];
            routineHistory = [];
            journalEntries = [];
            allTasks = [];
            allGoals = [];
        }

        // --- FUN√á√ïES DE TEMA ---
        function setTheme(theme) {
            currentTheme = theme;
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            }
            updateChartColors();
            renderThemeToggle(); // Atualiza o bot√£o
            renderAllCharts(); // Redesenha os gr√°ficos com as novas cores
        }
        
        function updateChartColors() {
             if (typeof Chart === 'undefined') return;
             const isDark = document.documentElement.classList.contains('dark');
             // Cores do Tailwind
             // light: text-slate-500 (grid), text-slate-800 (ticks)
             // dark: text-slate-400 (grid), text-slate-100 (ticks)
             Chart.defaults.color = isDark ? '#94a3b8' : '#334155';
             Chart.defaults.borderColor = isDark ? '#334155' : '#e2e8f0';
        }

        function renderThemeToggle() {
            const knob = document.getElementById('theme-toggle-knob');
            const button = document.getElementById('theme-toggle-button');
            if (knob && button) {
                if (currentTheme === 'dark') {
                    button.classList.replace('bg-slate-600', 'bg-sky-500');
                    knob.classList.add('translate-x-5');
                } else {
                    button.classList.replace('bg-sky-500', 'bg-slate-600');
                    knob.classList.remove('translate-x-5');
                }
            }
        }
        // --- FIM FUN√á√ïES DE TEMA ---


        // --- Carregamento de Dados (Firestore) ---

        function loadAllData() {
            if (!userId || !dbPathPrefix) {
                console.warn("loadAllData chamado sem userId ou dbPathPrefix. Abortando.");
                return;
            }
            console.log("Carregando dados de:", dbPathPrefix);
            
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];

            if (!db) {
                console.log("...loadAllData: DB n√£o encontrado, reinicializando...");
                db = getFirestore(initializeApp(firebaseConfig));
            }
            
            const routinesQuery = collection(db, `${dbPathPrefix}/routines`);
            const unsubRoutines = onSnapshot(routinesQuery, (snapshot) => {
                allRoutines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Rotinas carregadas:", allRoutines.length);
                if (auth.currentUser) render(); // S√≥ renderiza se ainda estiver logado
            }, (error) => console.error("Erro ao carregar rotinas:", error)); 
            unsubscribes.push(unsubRoutines); 

            const historyQuery = collection(db, `${dbPathPrefix}/routineHistory`);
            const unsubHistory = onSnapshot(historyQuery, (snapshot) => {
                routineHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Hist√≥rico de rotinas carregado:", routineHistory.length);
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar hist√≥rico:", error));
            unsubscribes.push(unsubHistory);

            const journalQuery = collection(db, `${dbPathPrefix}/journalEntries`);
            const unsubJournal = onSnapshot(journalQuery, (snapshot) => {
                journalEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Entradas do di√°rio carregadas:", journalEntries.length);
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar di√°rio:", error));
            unsubscribes.push(unsubJournal);

            const tasksQuery = collection(db, `${dbPathPrefix}/tasks`);
            const unsubTasks = onSnapshot(tasksQuery, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Tarefas carregadas:", allTasks.length);
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar tarefas:", error));
            unsubscribes.push(unsubTasks);

            const goalsQuery = collection(db, `${dbPathPrefix}/goals`);
            const unsubGoals = onSnapshot(goalsQuery, (snapshot) => {
                allGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Objetivos carregados:", allGoals.length);
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar objetivos:", error));
            unsubscribes.push(unsubGoals);
        }

        // --- Fun√ß√µes de Renderiza√ß√£o (UI) ---

        function render() {
            const appContainer = document.getElementById('app-container');
            const header = document.getElementById('main-header');
            const sidebar = document.getElementById('menu-sidebar');
            const menuButton = document.getElementById('menu-button');
            
            if (!appContainer || !header || !sidebar || !menuButton) return;
            
            // --- L√ìGICA DE RENDERIZA√á√ÉO ATUALIZADA ---
            switch(authState) {
                case 'VERIFICANDO':
                    // Mostra spinner
                    header.classList.add('hidden');
                    sidebar.classList.add('hidden');
                    menuButton.classList.add('hidden');
                    appContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
                            <p class="text-slate-600 dark:text-slate-400 text-xl mt-6 font-semibold">Verificando login...</p>
                        </div>`;
                    break;
                
                case 'DESLOGADO':
                    // Mostra tela de login
                    header.classList.add('hidden');
                    sidebar.classList.add('hidden');
                    menuButton.classList.add('hidden');
                    appContainer.innerHTML = renderLoginScreen();
                    break;
                
                case 'LOGADO':
                    // Mostra o app normal
                    header.classList.remove('hidden');
                    sidebar.classList.remove('hidden'); 
                    menuButton.classList.remove('hidden');
                
                    document.getElementById('header-date').innerText = todayFullDate;

                    switch (currentPage) {
                        case 'main':
                            appContainer.innerHTML = renderMainDashboard();
                            renderTodayJournalEntry(); 
                            break;
                        case 'routineStats':
                            appContainer.innerHTML = renderRoutineStats();
                            // Renderiza os gr√°ficos DEPOIS que o HTML (canvas) est√° na p√°gina
                            renderAllCharts();
                            break;
                        case 'journalView':
                            appContainer.innerHTML = renderJournalView();
                            break;
                        case 'taskCalendar':
                            appContainer.innerHTML = renderTaskCalendar();
                            break;
                        case 'goalView':
                            appContainer.innerHTML = renderGoalView();
                            break;
                    }
                    break;
            }
            // --- FIM DA L√ìGICA CONDICIONAL ---
            
            // Adiciona a vers√£o e o status de login ao menu
            const versionEl = document.getElementById('version-number');
            const authButtonEl = document.getElementById('auth-button-container');
            const authUserEl = document.getElementById('auth-user-display');
            
            if (versionEl) versionEl.innerText = `v${appVersion}`;
            
            if (authButtonEl && authUserEl) {
                if (authState === 'LOGADO' && currentUser) {
                     // Estado Logado
                    authUserEl.innerText = `Usu√°rio: ${currentUser.displayName || currentUser.email}`;
                    authButtonEl.innerHTML = `
                         <a href="#" data-action="auth-logout" class="flex items-center space-x-3 px-4 py-3 text-lg text-rose-400 hover:bg-slate-800 hover:text-rose-300 transition-colors duration-200 rounded-lg">
                            <i data-lucide="log-out" class=""></i>
                            <span>Sair (Logout)</span>
                        </a>`;
                } else {
                     // Estado Deslogado ou Verificando
                    authUserEl.innerText = "Deslogado";
                    authButtonEl.innerHTML = ``; // Sem bot√£o de login aqui
                }
            }

            renderThemeToggle(); // Renderiza o bot√£o do tema
            renderModal();
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function renderLoginScreen() {
             let errorMessage = '';
             if (authError) {
                 if (authError.code === 'auth/unauthorized-domain') {
                     errorMessage = "ERRO: O dom√≠nio `fabioyshiaki.github.io` n√£o est√° na lista de 'Dom√≠nios autorizados' no seu painel do Firebase.";
                 } else if (authError.code === 'auth/operation-not-allowed') {
                     errorMessage = "ERRO: O login com 'Google' est√° desativado no seu painel do Firebase.";
                 } else if (authError.code === 'local-config-error') {
                     errorMessage = `ERRO: ${authError.message}`;
                 } else {
                     errorMessage = `Erro: ${authError.message} (c√≥digo: ${authError.code})`;
                 }
             }
        
             return `
                <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                    <i data-lucide="brain" class="w-24 h-24 text-sky-500 mb-6"></i>
                    <h1 class="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-3">Bem-vindo ao Foco TDAH</h1>
                    <p class="text-xl text-slate-600 dark:text-slate-300 mb-10 max-w-md">Para salvar seus dados e sincronizar entre dispositivos, fa√ßa o login.</p>
                    <button id="google-login-btn" class="flex items-center justify-center space-x-3 w-full max-w-sm bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-lg font-semibold py-4 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.108-11.283-7.446l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.712 34.421 44 28.134 44 20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        <span>Entrar com Google</span>
                    </button>
                    <!-- Local para mostrar erros de login -->
                    <p id="auth-error-message" class="text-red-600 font-bold mt-6 text-lg max-w-sm">${errorMessage}</p>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-10">Vers√£o: ${appVersion}</p>
                </div>
            `;
        }

        function renderMainDashboard() {
            if (authState !== 'LOGADO') { 
                return `
                    <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
                        <p class="text-slate-600 dark:text-slate-400 text-xl mt-6 font-semibold">Carregando...</p>
                    </div>`;
            }
        
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 md:p-6">
                    <!-- 1. Rotinas Di√°rias -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Rotinas</h2>
                            <button data-action="open-modal" data-modal="addRoutine" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="routines-list" class="space-y-3">
                            ${renderTodayRoutines()}
                        </div>
                    </div>

                    <!-- 2. Di√°rio -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-4">Di√°rio de Hoje</h2>
                        <textarea id="journal-textarea" class="w-full h-36 p-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 dark:placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors" placeholder="Como foi o seu dia?"></textarea>
                        <button id="save-journal-btn" class="mt-4 w-full bg-sky-600 text-white text-lg font-bold py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Di√°rio
                        </button>
                    </div>

                    <!-- 3. Pr√≥ximas Tarefas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Pr√≥ximas Tarefas</h2>
                            <button data-action="open-modal" data-modal="addTask" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="tasks-list" class="space-y-3">
                            ${renderUpcomingTasks()}
                        </div>
                    </div>

                    <!-- 4. Objetivos -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Objetivos</h2>
                            <button data-action="open-modal" data-modal="addGoal" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="goals-list" class="space-y-3">
                            ${renderActiveGoals()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTodayRoutines() {
            if (allRoutines.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhuma rotina criada. Adicione uma no bot√£o '+' acima.</p>`;
            }
            return allRoutines.map(routine => {
                const historyEntry = routineHistory.find(h => h.routineId === routine.id && h.date === todayString);
                const isCompleted = historyEntry?.completed || false;
                
                return `
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                        <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                            <input type="checkbox" 
                                   class="form-checkbox h-7 w-7 text-sky-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-sky-500" 
                                   ${isCompleted ? 'checked' : ''}
                                   data-action="toggle-routine"
                                   data-routine-id="${routine.id}"
                                   data-routine-name="${routine.name}"
                                   data-history-id="${historyEntry?.id || ''}">
                            <span class="${isCompleted ? 'line-through text-slate-400 dark:text-slate-500' : ''}">${routine.name}</span>
                        </label>
                        <button data-action="delete-routine" data-id="${routine.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderUpcomingTasks() {
            const sevenDaysFromNow = new Date(todayDate);
            sevenDaysFromNow.setDate(todayDate.getDate() + 7);

            const upcomingTasks = allTasks.filter(task => {
                if (task.completed) return false;
                
                const [year, month, day] = task.date.split('-').map(Number);
                const taskDate = new Date(year, month - 1, day);
                
                return taskDate >= todayDate && taskDate <= sevenDaysFromNow;
            });

            upcomingTasks.sort((a, b) => a.date.localeCompare(b.date));

            if (upcomingTasks.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhuma tarefa para os pr√≥ximos 7 dias. Adicione uma no bot√£o '+' acima.</p>`;
            }
            
            return upcomingTasks.map(task => {
                const daysRemaining = getDaysRemaining(task.date);
                
                let colorClass = '';
                let daysText = '';

                if (daysRemaining >= 5) { // 7, 6, 5 dias
                    colorClass = 'bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-800 dark:text-emerald-200 dark:border-emerald-700';
                } else if (daysRemaining >= 2) { // 4, 3, 2 dias
                    colorClass = 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-800 dark:text-orange-200 dark:border-orange-700';
                } else { // 1, 0 dias
                    colorClass = 'bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-800 dark:text-rose-200 dark:border-rose-700';
                }

                if (daysRemaining === 0) {
                    daysText = 'Hoje';
                } else if (daysRemaining === 1) {
                    daysText = '1 dia';
                } else {
                    daysText = `${daysRemaining} dias`;
                }

                return `
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                        <span class="text-xl text-slate-800 dark:text-slate-100">${task.name}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-sm px-2.5 py-0.5 rounded-full border ${colorClass}">
                                ${daysText}
                            </span>
                            <button data-action="complete-task" data-id="${task.id}" class="text-emerald-500 hover:text-emerald-700 transition-colors">
                                <i data-lucide="check-circle" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActiveGoals() {
            const activeGoals = allGoals.filter(goal => !goal.completed);
            if (activeGoals.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhum objetivo ativo. Adicione um no bot√£o '+' acima.</p>`;
            }
            return activeGoals.map(goal => `
                <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                    <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                        <input type="checkbox" 
                               class="form-checkbox h-7 w-7 text-emerald-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-emerald-500"
                               data-action="complete-goal"
                               data-id="${goal.id}">
                        <span>${goal.name}</span>
                    </label>
                    <button data-action="delete-goal" data-id="${goal.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function renderTodayJournalEntry() {
            const journalTextarea = document.getElementById('journal-textarea');
            if (journalTextarea) {
                const todayEntry = journalEntries.find(entry => entry.id === todayString);
                journalTextarea.value = todayEntry ? todayEntry.text : '';
            }
        }

        // --- Renderiza√ß√£o das P√°ginas do Menu ---

        // --- P√ÅGINA DE ESTAT√çSTICAS COM GR√ÅFICOS (v2.0.0) ---
        function renderRoutineStats() {
            // Esta fun√ß√£o agora apenas desenha os containers dos gr√°ficos
            return `
                <div class="p-6">
                    <h2 class="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-8">Estat√≠sticas de Rotinas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Gr√°fico de Hoje -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                            <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Hoje</h3>
                            <div class="h-64 flex items-center justify-center">
                                <canvas id="todayChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico da Semana -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">√öltimos 7 Dias</h3>
                            <div class="h-64">
                                <canvas id="weekChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico do M√™s -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">√öltimas 4 Semanas</h3>
                            <div class="h-64">
                                <canvas id="monthChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico do Ano -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Este Ano</h3>
                            <div class="h-64">
                                <canvas id="yearChart"></canvas>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // --- NOVAS FUN√á√ïES DE GR√ÅFICOS ---
        
        function renderAllCharts() {
            if (typeof Chart === 'undefined') {
                 console.error("Chart.js n√£o foi carregado.");
                 return;
            }
            renderTodayChart();
            renderWeekChart();
            renderMonthChart();
            renderYearChart();
        }
        
        function renderTodayChart() {
            const ctx = document.getElementById('todayChart')?.getContext('2d');
            if (!ctx) return;

            const todayEntries = routineHistory.filter(h => h.date === todayString);
            const completed = todayEntries.filter(h => h.completed).length;
            const total = allRoutines.length;
            const pending = total - completed;

            if (window.myCharts.todayChart) window.myCharts.todayChart.destroy();
            
            window.myCharts.todayChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Conclu√≠das', 'Pendentes'],
                    datasets: [{
                        data: [completed, pending < 0 ? 0 : pending],
                        backgroundColor: [
                            '#0ea5e9', // sky-500
                            '#334155'  // slate-700
                        ],
                        borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff', // bg-slate-800 ou bg-white
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20
                            }
                        }
                    }
                }
            });
        }
        
        function renderWeekChart() {
            const ctx = document.getElementById('weekChart')?.getContext('2d');
            if (!ctx) return;

            const labels = [];
            const data = [];
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const totalRoutines = allRoutines.length > 0 ? allRoutines.length : 1; // Evita divis√£o por zero

            for (let i = 6; i >= 0; i--) {
                const date = new Date(todayDate);
                date.setDate(date.getDate() - i);
                
                const dateString = getLocalYYYYMMDD(date);
                const dayLabel = dayNames[date.getDay()];
                labels.push(dayLabel);
                
                const completed = routineHistory.filter(h => h.date === dateString && h.completed).length;
                const percentage = (completed / totalRoutines) * 100;
                data.push(percentage);
            }

            if (window.myCharts.weekChart) window.myCharts.weekChart.destroy();
            
            window.myCharts.weekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: data,
                        backgroundColor: '#0ea5e9', // sky-500
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function renderMonthChart() {
            const ctx = document.getElementById('monthChart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = ['Sem 4', 'Sem 3', 'Sem 2', 'Sem 1 (Atual)'];
            const data = [];
            const totalRoutines = allRoutines.length > 0 ? allRoutines.length : 1;

            for (let w = 3; w >= 0; w--) {
                const weekStart = new Date(todayDate);
                weekStart.setDate(weekStart.getDate() - (w * 7) - todayDate.getDay()); // In√≠cio da semana (Dom)
                
                let completedCount = 0;
                let dayCount = 0;
                
                for (let d = 0; d < 7; d++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + d);
                    const dateString = getLocalYYYYMMDD(date);
                    
                    // S√≥ conta dias at√© "hoje"
                    if (date <= todayDate) {
                        const entries = routineHistory.filter(h => h.date === dateString && h.completed);
                        completedCount += entries.length;
                        dayCount++;
                    }
                }
                
                const totalPossible = dayCount * totalRoutines;
                const percentage = totalPossible > 0 ? (completedCount / totalPossible) * 100 : 0;
                data.push(percentage);
            }

            if (window.myCharts.monthChart) window.myCharts.monthChart.destroy();
            
            window.myCharts.monthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: data,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function renderYearChart() {
            const ctx = document.getElementById('yearChart')?.getContext('2d');
            if (!ctx) return;

            const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const data = Array(12).fill(0);
            const daysInMonth = Array(12).fill(0).map((_, i) => new Date(todayDate.getFullYear(), i + 1, 0).getDate());
            const totalRoutines = allRoutines.length > 0 ? allRoutines.length : 1;
            const currentYear = todayDate.getFullYear();
            const currentMonth = todayDate.getMonth();

            const yearEntries = routineHistory.filter(h => h.date.startsWith(currentYear));

            yearEntries.forEach(h => {
                const month = parseInt(h.date.split('-')[1], 10) - 1; // 0-11
                if (h.completed) {
                    data[month]++;
                }
            });
            
            // Calcula porcentagem
            const percentageData = data.map((completedCount, month) => {
                let totalDaysInMonth = daysInMonth[month];
                // Se for o m√™s atual, conta apenas os dias at√© hoje
                if(month === currentMonth) {
                    totalDaysInMonth = todayDate.getDate();
                }
                // Se for m√™s futuro, zera
                if (month > currentMonth) {
                    totalDaysInMonth = 0;
                }
                
                const totalPossible = totalDaysInMonth * totalRoutines;
                return totalPossible > 0 ? (completedCount / totalPossible) * 100 : 0;
            });

            if (window.myCharts.yearChart) window.myCharts.yearChart.destroy();
            
            window.myCharts.yearChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: percentageData,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }


        // --- DI√ÅRIO COM ACORDE√ÉO (v2.0.0) ---
        function renderJournalView() {
            const entriesByMonth = {};
            journalEntries.forEach(entry => {
                const [year, month] = entry.id.split('-'); // YYYY-MM-DD
                const monthKey = `${year}-${month}`;
                if (!entriesByMonth[monthKey]) {
                    entriesByMonth[monthKey] = [];
                }
                entriesByMonth[monthKey].push(entry);
            });

            const sortedMonths = Object.keys(entriesByMonth).sort().reverse();
            
            let html = `<div class="p-6"><h2 class="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-8">Meu Di√°rio</h2><div class="space-y-4">`;

            if (sortedMonths.length === 0) {
                 html += `<p class="text-slate-500 dark:text-slate-400 text-center mt-8 text-lg">Nenhuma entrada no di√°rio ainda.</p>`;
            }

            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                html += `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
                            <button data-action="toggle-month" data-month-id="month-${monthKey}" class="w-full flex justify-between items-center p-6">
                                <h3 class="text-3xl font-semibold text-sky-700 dark:text-sky-500 capitalize">${monthName}</h3>
                                <i data-lucide="chevron-down" class="text-slate-500 transition-transform"></i>
                            </button>
                            <div id="month-${monthKey}" class="hidden space-y-5 px-6 pb-6 pt-2 border-t border-slate-200 dark:border-slate-700">`;
                
                entriesByMonth[monthKey].sort((a, b) => b.id.localeCompare(a.id)).forEach(entry => {
                    const [y, m, d] = entry.id.split('-').map(Number);
                    const entryDate = new Date(y, m - 1, d).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
                    html += `
                        <div class="border-b border-slate-200 dark:border-slate-700 pb-4">
                            <p class="text-lg font-semibold text-slate-800 dark:text-slate-100">${entryDate}</p>
                            <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap mt-1">${entry.text}</p>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            html += `</div></div>`;
            return html;
        }

        function renderTaskCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-11
            const monthName = currentCalendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Dom, 1=Seg, ...
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            let html = `
                <div class="p-4 md:p-6">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-5xl mx-auto">
                        <!-- Header do Calend√°rio -->
                        <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                            <button data-action="calendar-prev" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 dark:hover:text-slate-100 transition-colors">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                            </button>
                            <h2 class="text-3xl font-bold text-sky-700 dark:text-sky-500 capitalize">${monthName}</h2>
                            <button data-action="calendar-next" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 dark:hover:text-slate-100 transition-colors">
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <!-- Grid dos Dias -->
                        <div class="grid grid-cols-7">
                            <!-- Cabe√ßalho dos dias da semana -->
                            ${daysOfWeek.map(day => `<div class="text-center font-semibold text-slate-500 dark:text-slate-400 p-4 border-b border-slate-200 dark:border-slate-700">${day}</div>`).join('')}
                            
                            <!-- Dias em branco (in√≠cio) -->
                            ${Array(firstDayOfMonth).fill('').map(() => `<div class="border-r border-b border-slate-200 dark:border-slate-700 h-32"></div>`).join('')}

                            <!-- Dias do m√™s -->
                            ${Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => {
                                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const tasksForDay = allTasks.filter(task => task.date === dateStr);
                                const isToday = dateStr === todayString;

                                return `
                                    <div class="border-r border-b border-slate-200 dark:border-slate-700 h-32 p-2 overflow-y-auto relative">
                                        <div class="font-semibold text-lg ${isToday ? 'bg-sky-600 text-white rounded-full w-8 h-8 flex items-center justify-center' : 'text-slate-700 dark:text-slate-300'}">${day}</div>
                                        <div class="mt-2 space-y-1">
                                            ${tasksForDay.map(task => `
                                                <div class="text-xs p-1 rounded font-medium ${task.completed ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-800 dark:text-emerald-200 line-through' : 'bg-sky-100 text-sky-800 dark:bg-sky-800 dark:text-sky-200'}">
                                                    ${task.name}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function renderGoalView() {
            const activeGoals = allGoals.filter(goal => !goal.completed);
            const completedGoals = allGoals.filter(goal => goal.completed);

            return `
                <div class="p-6">
                    <h2 class="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-8">Meus Objetivos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Objetivos N√£o Conclu√≠dos -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                            <h3 class="text-3xl font-semibold text-slate-700 dark:text-slate-200 mb-5">Ativos</h3>
                            <div class="space-y-4">
                                ${activeGoals.length > 0 ? activeGoals.map(goal => `
                                    <p class="text-xl text-slate-700 dark:text-slate-200 p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg">${goal.name}</p>
                                `).join('') : `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum objetivo ativo.</p>`}
                            </div>
                        </div>
                        
                        <!-- Objetivos Conclu√≠dos -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl">
                            <h3 class="text-3xl font-semibold text-slate-700 dark:text-slate-200 mb-5">Conclu√≠dos</h3>
                            <div class="space-y-4">
                                ${completedGoals.length > 0 ? completedGoals.map(goal => `
                                    <p class="text-xl text-slate-400 dark:text-slate-500 line-through p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg">${goal.name}</p>
                                `).join('') : `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum objetivo conclu√≠do ainda.</p>`}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Renderiza√ß√£o do Modal ---

        function renderModal() {
            const modalContainer = document.getElementById('modal-container');
            if (!currentModal) {
                modalContainer.innerHTML = '';
                return;
            }

            let modalTitle = '';
            let modalContent = '';

            switch (currentModal) {
                case 'addRoutine':
                    modalTitle = 'Nova Rotina Di√°ria';
                    modalContent = `
                        <label for="routine-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome da Rotina</label>
                        <input type="text" id="routine-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Tomar caf√© da manh√£">
                        <button id="save-routine-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Rotina
                        </button>
                    `;
                    break;
                case 'addTask':
                    modalTitle = 'Nova Tarefa Agendada';
                    modalContent = `
                        <label for="task-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome da Tarefa</label>
                        <input type="text" id="task-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Consulta m√©dica">
                        
                        <label for="task-date" class="block text-lg font-medium text-slate-700 dark:text-slate-200 mt-4">Data</label>
                        <input type="date" id="task-date" value="${todayString}" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                        
                        <button id="save-task-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Tarefa
                        </button>
                    `;
                    break;
                case 'addGoal':
                    modalTitle = 'Novo Objetivo';
                    modalContent = `
                        <label for="goal-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome do Objetivo</label>
                        <input type="text" id="goal-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Ler 1 livro este m√™s">
                        <button id="save-goal-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Objetivo
                        </button>
                    `;
                    break;
            }

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-40" data-action="close-modal"></div>
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-2xl shadow-2xl">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-3xl font-bold text-slate-800 dark:text-slate-100">${modalTitle}</h3>
                            <button data-action="close-modal" class="text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300">
                                <i data-lucide="x" class="w-8 h-8"></i>
                            </button>
                        </div>
                        <div>
                            ${modalContent}
                        </div>
                    </div>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- Navega√ß√£o e Event Listeners ---
        
        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                
                // Listener do Bot√£o de Login
                if (e.target.closest('#google-login-btn')) {
                    handleGoogleLogin();
                    return;
                }
                
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                
                // A√ß√£o de Logout
                if (action === 'auth-logout') {
                    handleLogout();
                    return;
                }
                
                // A√ß√£o de Mudar Tema
                if (action === 'toggle-theme') {
                    setTheme(currentTheme === 'light' ? 'dark' : 'light');
                    return;
                }
                
                // A√ß√£o de Acorde√£o do Di√°rio
                if (action === 'toggle-month') {
                    const monthId = target.dataset.monthId;
                    const content = document.getElementById(monthId);
                    const icon = target.querySelector('i');
                    if (content) content.classList.toggle('hidden');
                    if (icon) icon.classList.toggle('rotate-180');
                    return;
                }

                // A√ß√µes do Menu
                if (action === 'open-menu') {
                    document.getElementById('menu-sidebar').classList.remove('-translate-x-full');
                    document.getElementById('menu-overlay').classList.remove('hidden');
                }
                if (action === 'close-menu') {
                    document.getElementById('menu-sidebar').classList.add('-translate-x-full');
                    document.getElementById('menu-overlay').classList.add('hidden');
                }
                if (action.startsWith('nav-')) {
                    currentPage = action.split('-')[1];
                    document.getElementById('menu-sidebar').classList.add('-translate-x-full');
                    document.getElementById('menu-overlay').classList.add('hidden');
                    render();
                }

                // A√ß√µes do Modal
                if (action === 'open-modal') {
                    currentModal = target.dataset.modal;
                    renderModal();
                }
                if (action === 'close-modal') {
                    currentModal = null;
                    renderModal();
                }

                // A√ß√µes de Salvar (CRUD)
                if (action === 'save-routine') handleAddRoutine();
                if (action === 'save-task') handleAddTask();
                if (action === 'save-goal') handleAddGoal();
                if (action === 'save-journal') handleSaveJournal();

                // A√ß√µes de Itens (CRUD)
                if (action === 'toggle-routine') handleToggleRoutine(target);
                if (action === 'delete-routine') handleDeleteRoutine(target.dataset.id);
                if (action === 'complete-task') handleCompleteTask(target.dataset.id);
                if (action === 'complete-goal') handleCompleteGoal(target.dataset.id, target.checked);
                if (action === 'delete-goal') handleDeleteGoal(target.dataset.id);
                
                // A√ß√µes do Calend√°rio
                if (action === 'calendar-prev') {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                    render();
                }
                if (action === 'calendar-next') {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                    render();
                }
            });
            
            // Listener separado para os bot√µes de salvar (pois eles s√£o recriados)
            document.body.addEventListener('click', e => {
                if (e.target.id === 'save-journal-btn') {
                    handleSaveJournal();
                }
                if (e.target.id === 'save-routine-btn') {
                    handleAddRoutine();
                }
                if (e.target.id === 'save-task-btn') {
                    handleAddTask();
                }
                if (e.target.id === 'save-goal-btn') {
                    handleAddGoal();
                }
            });
        }
        
        // --- Fun√ß√µes de Manipula√ß√£o de Dados (CRUD) ---

        async function handleAddRoutine() {
            const input = document.getElementById('routine-name');
            const name = input.value.trim();
            if (name && userId) { 
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/routines`), {
                        name: name,
                        createdAt: new Date().toISOString()
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar rotina:", error);
                }
            } else if (!name) {
                console.warn("Nome da rotina est√° vazio.");
            } else if (!userId) {
                console.error("Usu√°rio n√£o autenticado. N√£o √© poss√≠vel salvar.");
            }
        }
        
        async function handleDeleteRoutine(routineId) {
            showConfirmationModal("Tem certeza que deseja excluir esta rotina? Todo o hist√≥rico dela ser√° perdido.", async () => {
                if (!userId) return;
                try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/routines`, routineId));
                    
                    const historyQuery = query(collection(db, `${dbPathPrefix}/routineHistory`), where("routineId", "==", routineId));
                    const historySnapshot = await getDocs(historyQuery);
                    const batch = writeBatch(db);
                    historySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    console.log("Rotina e hist√≥rico deletados.");
                } catch (error) {
                    console.error("Erro ao deletar rotina:", error);
                }
            });
        }
        
        async function handleToggleRoutine(checkbox) {
            const { routineId, routineName, historyId } = checkbox.dataset;
            const isCompleted = checkbox.checked;

            if (!userId) return;

            try {
                const historyDocId = historyId || `${routineId}_${todayString}`;
                const historyDocRef = doc(db, `${dbPathPrefix}/routineHistory`, historyDocId);
                
                await setDoc(historyDocRef, {
                    routineId: routineId,
                    routineName: routineName,
                    date: todayString,
                    completed: isCompleted
                }, { merge: true }); 
                
            } catch (error) {
                console.error("Erro ao atualizar rotina:", error);
            }
        }
        
        async function handleSaveJournal() {
            const textarea = document.getElementById('journal-textarea');
            const text = textarea.value;
            if (userId) {
                try {
                    const journalDocRef = doc(db, `${dbPathPrefix}/journalEntries`, todayString);
                    await setDoc(journalDocRef, {
                        text: text,
                        lastUpdatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    const btn = document.getElementById('save-journal-btn');
                    btn.innerText = 'Salvo!';
                    btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
                    btn.classList.remove('bg-sky-600', 'hover:bg-sky-700');
                    setTimeout(() => {
                        btn.innerText = 'Salvar Di√°rio';
                        btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                        btn.classList.add('bg-sky-600', 'hover:bg-sky-700');
                    }, 2000);
                    
                } catch (error) {
                    console.error("Erro ao salvar di√°rio:", error);
                }
            }
        }
        
        async function handleAddTask() {
            const name = document.getElementById('task-name').value.trim();
            const date = document.getElementById('task-date').value;
            if (name && date && userId) {
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/tasks`), {
                        name: name,
                        date: date,
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar tarefa:", error);
                }
            }
        }
        
        async function handleCompleteTask(taskId) {
            if (!userId) return;
            try {
                const taskDocRef = doc(db, `${dbPathPrefix}/tasks`, taskId);
                await updateDoc(taskDocRef, {
                    completed: true
                });
            } catch (error)
 {
                console.error("Erro ao completar tarefa:", error);
            }
        }
        
        async function handleAddGoal() {
            const name = document.getElementById('goal-name').value.trim();
            if (name && userId) {
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/goals`), {
                        name: name,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar objetivo:", error);
                }
            }
        }
        
        async function handleCompleteGoal(goalId, isCompleted) {
             if (!userId) return;
             if (!isCompleted) return; 
             
            try {
                const goalDocRef = doc(db, `${dbPathPrefix}/goals`, goalId);
                await updateDoc(goalDocRef, {
                    completed: true,
                    completedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error("Erro ao completar objetivo:", error);
            }
        }
        
        async function handleDeleteGoal(goalId) {
            showConfirmationModal("Tem certeza que deseja excluir este objetivo?", async () => {
                if (!userId) return;
                 try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/goals`, goalId));
                } catch (error) {
                    console.error("Erro ao deletar objetivo:", error);
                }
            });
        }
        
        // --- Fun√ß√µes Auxiliares (Modal de Confirma√ß√£o) ---
        
        function getDaysRemaining(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const taskDate = new Date(year, month - 1, day); 
            
            const diffTime = taskDate.getTime() - todayDate.getTime();
            
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            return diffDays < 0 ? 0 : diffDays;
        }

        function showConfirmationModal(message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            const confirmationId = 'modal-confirm-' + Date.now();
            
            const modalHtml = `
                <div id="${confirmationId}" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" data-action="close-confirm"></div>
                    <div class="bg-white dark:bg-slate-800 w-full max-w-sm p-6 rounded-2xl shadow-2xl z-10">
                        <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 mb-4">Confirmar A√ß√£o</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-6 text-lg">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button data-action="close-confirm" class="px-5 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button data-action="confirm-action" class="px-5 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold transition-colors">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
            
            const modalElement = document.getElementById(confirmationId);

            const handleConfirmationClick = (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                if (target.dataset.action === 'confirm-action') {
                    onConfirm();
                    modalElement.remove();
                }
                if (target.dataset.action === 'close-confirm') {
                    modalElement.remove();
                }
            };
            
            modalElement.addEventListener('click', handleConfirmationClick);
        }

    </script>

    <style>
        /* Estilo base */
        html.dark body {
            background-color: #0f172a; /* bg-slate-900 */
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Remove o spinner padr√£o de inputs[type=date] (opcional) */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        /* Cor do texto do input[type=date] no modo escuro */
        .dark input[type="date"] {
            color-scheme: dark;
        }

        /* Checkbox customizado */
        .form-checkbox {
            appearance: none;
            -webkit-appearance: none;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            border-width: 2px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        .form-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-position: center;
            background-repeat: no-repeat;
            background-size: 100% 100%;
        }
        .form-checkbox:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
             --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);
             box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
             --tw-ring-opacity: 0.5;
        }
    </style>
</head>
<body class="antialiased font-sans bg-slate-100 dark:bg-slate-900">

    <!-- Menu Lateral (Sidebar) -->
    <div id="menu-overlay" data-action="close-menu" class="fixed inset-0 bg-black bg-opacity-60 z-10 hidden transition-opacity"></div>
    <div id="menu-sidebar" class="fixed top-0 left-0 w-72 h-full bg-slate-900 text-slate-200 z-20 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-6">
            <h2 class="text-3xl font-bold text-sky-400">Foco TDAH</h2>
            <p class="text-slate-400 text-sm">Seu assistente</p>
        </div>
        <nav class="mt-6 flex flex-col h-[calc(100%-120px)]"> <!-- Ajuste de altura -->
            <div class="flex-grow"> <!-- Itens do menu -->
                <a href="#" data-action="nav-main" class="flex items-center space-x-3 px-6 py-4 text-lg text-slate-200 hover:bg-slate-800 hover:text-white transition-colors duration-200">
                    <i data-lucide="layout-dashboard" class="text-slate-400"></i>
                    <span>Painel Principal</span>
                </a>
                <a href="#" data-action="nav-routineStats" class="flex items-center space-x-3 px-6 py-4 text-lg text-slate-200 hover:bg-slate-800 hover:text-white transition-colors duration-200">
                    <i data-lucide="pie-chart" class="text-slate-400"></i>
                    <span>Estat√≠sticas (Rotinas)</span>
                </a>
                <a href="#" data-action="nav-journalView" class="flex items-center space-x-3 px-6 py-4 text-lg text-slate-200 hover:bg-slate-800 hover:text-white transition-colors duration-200">
                    <i data-lucide="book-open" class="text-slate-400"></i>
                    <span>Ver Di√°rio</span>
                </a>
                <a href="#" data-action="nav-taskCalendar" class="flex items-center space-x-3 px-6 py-4 text-lg text-slate-200 hover:bg-slate-800 hover:text-white transition-colors duration-200">
                    <i data-lucide="calendar-days" class="text-slate-400"></i>
                    <span>Calend√°rio (Tarefas)</span>
                </a>
                <a href="#" data-action="nav-goalView" class="flex items-center space-x-3 px-6 py-4 text-lg text-slate-200 hover:bg-slate-800 hover:text-white transition-colors duration-200">
                    <i data-lucide="target" class="text-slate-400"></i>
                    <span>Ver Objetivos</span>
                </a>
            </div>
            <!-- Informa√ß√µes de Vers√£o e Login/Logout -->
            <div class="p-4 border-t border-slate-700">
                <!-- Bot√£o de Tema -->
                <div class="flex justify-between items-center px-4 py-3 mb-2">
                    <span class="text-lg text-slate-200">Modo Escuro</span>
                    <button id="theme-toggle-button" data-action="toggle-theme" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-slate-600">
                        <span id="theme-toggle-knob" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                    </button>
                </div>
                
                 <div id="auth-user-display" class="px-4 py-2 text-sm text-slate-400">Carregando...</div>
                 <div id="auth-button-container">
                    <!-- O bot√£o de Login/Logout √© renderizado aqui -->
                 </div>
                 <div class="px-4 py-2 text-xs text-slate-500" id="version-number">v...</div>
            </div>
        </nav>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="min-h-screen">
        <!-- Header Principal -->
        <header id="main-header" class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-0 border-b border-slate-200 dark:border-slate-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Bot√£o Menu -->
                    <button id="menu-button" data-action="open-menu" class="text-slate-600 dark:text-slate-300 hover:text-sky-600 transition-colors">
                        <i data-lucide="menu" class="w-8 h-8"></i>
                    </button>
                    <!-- Data -->
                    <div class="text-center">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Painel Principal</h1>
                        <p id="header-date" class="text-sm text-slate-500 dark:text-slate-400 font-medium"></p>
                    </div>
                    <!-- Espa√ßador (ou √≠cone de perfil) -->
                    <div class="w-8"></div>
                </div>
            </div>
        </header>

        <!-- Container da P√°gina -->
        <main id="app-container" class="pb-24">
            <!-- Loading Spinner inicial -->
             <div class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
            </div>
        </main>
    </div>
    
    <!-- Container do Modal -->
    <div id="modal-container">
        <!-- O modal √© renderizado aqui pelo JavaScript -->
    </div>

</body>
</html>

