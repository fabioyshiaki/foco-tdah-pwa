<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Foco TDAH</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configura√ß√£o do Tailwind para Dark Mode -->
    <script>
        tailwind.config = {
          darkMode: 'class', // Habilita o modo escuro baseado em classe (no <html>)
        }
    </script>
    
    <!-- Script de Carregamento do Tema (Evita "flash") -->
    <script>
      // Verifica se o usu√°rio j√° tem uma prefer√™ncia salva
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons (para √≠cones) -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <!-- Chart.js (Para os gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FullCalendar (Para Calend√°rio Avan√ßado) -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, // Este √© o updateDoc do Firestore
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            writeBatch,
            getDocs,
            terminate,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VERS√ÉO DO APP ---
        const appVersion = "2.6.2 (Gr√°ficos Interativos)";
        // ---------------------

        // --- PASSO 1: COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        // COLE SUA CHAVE 'apiKey' SECRETA NA LINHA ABAIXO:
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCUnLyL9T4OaZsQnie-8ACry9zSm8XlLjU",
  authDomain: "meu-foco-pwa.firebaseapp.com",
  databaseURL: "https://meu-foco-pwa-default-rtdb.firebaseio.com",
  projectId: "meu-foco-pwa",
  storageBucket: "meu-foco-pwa.firebasestorage.app",
  messagingSenderId: "126519054955",
  appId: "1:126519054955:web:7576cc1170dc2a17ef972e"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        // ----------------------------------------------------
        
        // Objeto global para guardar inst√¢ncias dos gr√°ficos e calend√°rio
        window.myCharts = {};
        window.myCalendar = null;
        window.reminderInterval = null; 
        
        let db, auth, userId, appId;
        let dbPathPrefix = '';
        let currentUser = null; 
        let authError = null; 

        // Arrays para guardar os dados do Firestore
        let allRoutines = [];
        let routineHistory = [];
        let journalEntries = [];
        let allTasks = [];
        let allGoals = [];
        let allAlerts = [];
        
        let unsubscribes = []; 

        // Estado da UI
        let authState = 'VERIFICANDO'; // 'VERIFICANDO', 'LOGADO', 'DESLOGADO'
        let currentPage = 'main'; // main, journalView, taskCalendar, progress
        let currentModal = null; // addRoutine, addTask, addGoal, settings, taskDayView, addAlert, taskReminder, dayRoutineStats
        let currentCalendarDate = new Date();
        let currentTheme = 'light'; // 'light' ou 'dark'
        let selectedDate = null; // Guarda o dia clicado no calend√°rio
        let taskForReminder = null; // Guarda a tarefa do lembrete
        
        // --- Fonte √önica de Verdade para "Hoje" (BASEADO NO LOCAL) ---
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); 

        function getLocalYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        let todayString = getLocalYYYYMMDD(todayDate);
        let todayFullDate = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
        // --- Fim da Fonte de Verdade ---


        // --- PWA (Manifest & Service Worker) ---
        
        // 1. Manifesto (inline)
        const manifest = {
            "name": "Foco TDAH",
            "short_name": "Foco",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f1f5f9", // bg-slate-100
            "theme_color": "#0ea5e9", // bg-sky-500
            "description": `Seu assistente pessoal para rotinas, tarefas e foco. v${appVersion}`,
            "icons": [
                { "src": "https://placehold.co/192x192/0ea5e9/white?text=Foco&font=sans-serif", "type": "image/png", "sizes": "192x192" },
                { "src": "https://placehold.co/512x512/0ea5e9/white?text=Foco&font=sans-serif", "type": "image/png", "sizes": "512x512" }
            ]
        };
        const manifestString = JSON.stringify(manifest);
        const manifestUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(manifestString);
        document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`);

        // 2. Service Worker (inline)
        const swScript = `
            const CACHE_NAME = 'foco-tdah-cache-v${appVersion}'; // Vers√£o do Cache
            const urlsToCache = [
                '/',
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js', 
                'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js', 
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js',
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js',
                'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js',
                'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap',
                'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2'
            ];

            // Limpa caches antigos
            self.addEventListener('activate', event => {
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.filter(cacheName => cacheName !== CACHE_NAME)
                                      .map(cacheName => caches.delete(cacheName))
                        );
                    })
                );
            });

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Cache aberto');
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            // L√ìGICA DE CACHE SIMPLIFICADA (s√≥ rede primeiro para o index)
            self.addEventListener('fetch', event => {
                if (event.request.mode === 'navigate') {
                    event.respondWith(
                        fetch(event.request).catch(() => caches.match(event.request))
                    );
                } else {
                     event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                    );
                }
            });
        `;
        const swUrl = 'data:application/javascript,' + encodeURIComponent(swScript);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('Service Worker v2.6.1 registrado', registration.scope))
                    .catch(error => console.error('Falha no registro do Service Worker', error));
            });
        }
        // --- FIM PWA ---


        // --- Inicializa√ß√£o ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Define o estado inicial do tema
            currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateChartColors(); // Configura as cores do Chart.js
            
            initializeAppFirebase();
            setupEventListeners();
            render(); // Renderiza o estado inicial (loading spinner)
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.warn("Lucide n√£o carregou a tempo no DOMContentLoaded");
            }
        });

        // --- L√ìGICA DE LOGIN ---
        function setLoggedInState(user) {
            console.log("...setLoggedInState chamado com:", user ? user.email : "null");
            currentUser = user; 
            userId = user.uid;
            authState = 'LOGADO';
            dbPathPrefix = `/artifacts/${appId}/users/${userId}`;
            
            if (!db) {
                db = getFirestore(initializeApp(firebaseConfig));
            }
            
            loadAllData();
            render();
            
            // Inicia o verificador de lembretes
            if (window.reminderInterval) clearInterval(window.reminderInterval);
            window.reminderInterval = setInterval(checkTaskReminders, 60000); // Roda a cada 60 segundos
            checkTaskReminders(); // Roda uma vez imediatamente
        }
        
        function setLoggedOutState(error) {
            console.log("...setLoggedOutState chamado");
            currentUser = null;
            userId = null;
            authState = 'DESLOGADO';
            authError = error; // Salva o erro, se houver
            clearAllData();
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            
            // Para o verificador de lembretes
            if (window.reminderInterval) clearInterval(window.reminderInterval);
            window.reminderInterval = null;
            
            render();
        }

        async function initializeAppFirebase() {
            try {
                appId = firebaseConfig.projectId || 'default-app-id';

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "SUA_CHAVE_API_SECRETA_COLE_AQUI") {
                    console.error("Configura√ß√£o do Firebase n√£o encontrada.");
                    authError = { code: "local-config-error", message: "Chave API n√£o encontrada. Edite o arquivo HTML e cole sua chave API." };
                    authState = 'DESLOGADO';
                    render();
                    return;
                }

                console.log("Firebase inicializado. Verificando estado de autentica√ß√£o...");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                
                // L√≥gica de Popup (v1.8.0) - s√≥ checa sess√£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("‚úÖ Login via Sess√£o:", user.email);
                        setLoggedInState(user);
                    } else {
                        console.log("‚ùå Deslogado.");
                        setLoggedOutState(null);
                    }
                    setupAuthListener(); // Configura o listener para logout futuro
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                setLoggedOutState(error);
            }
        }
        
        // Listener para mudan√ßas futuras (principalmente logout)
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (!user && authState === 'LOGADO') {
                    // Usu√°rio acabou de deslogar
                    console.log("üîÑ Evento de Logout detectado.");
                    setLoggedOutState(null);
                }
            });
        }
        
        // --- FUN√á√ïES DE LOGIN / LOGOUT ---
        
        async function handleGoogleLogin() {
            authError = null; // Limpa erros antigos
            render(); 
        
            const provider = new GoogleAuthProvider();
            try {
                console.log("handleGoogleLogin: Iniciando signInWithPopup...");
                const result = await signInWithPopup(auth, provider);
                
                if (result) {
                    console.log("‚úÖ Login via Popup:", result.user.email);
                    setLoggedInState(result.user);
                } else {
                    console.warn('Popup fechado sem login.');
                    // N√£o faz nada, continua deslogado
                }
            } catch (error) {
                console.error("Erro ao logar com Popup", error.code, error.message);
                setLoggedOutState(error);
            }
        }
        
        async function handleLogout() {
            try {
                unsubscribes.forEach(unsub => unsub());
                unsubscribes = [];
                
                if (db) {
                    await terminate(db);
                    db = null; 
                }
                
                await signOut(auth);
                // O 'onAuthStateChanged' (configurado em setupAuthListener)
                // vai pegar o evento de logout e chamar setLoggedOutState.
                
            } catch (error) {
                console.error("Erro ao fazer logout", error.message);
            }
        }
        
        function clearAllData() {
            allRoutines = [];
            routineHistory = [];
            journalEntries = [];
            allTasks = [];
            allGoals = [];
            allAlerts = [];
        }

        // --- FUN√á√ïES DE TEMA ---
        function setTheme(theme) {
            currentTheme = theme;
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            }
            updateChartColors();
            renderThemeToggle(); // Atualiza o bot√£o no modal de settings
            if (currentPage === 'progress') {
                renderAllCharts(); // Redesenha os gr√°ficos com as novas cores
            }
            if (currentPage === 'taskCalendar') {
                 // Recria o calend√°rio para aplicar o tema
                 initializeFullCalendar();
            }
        }
        
        function updateChartColors() {
             if (typeof Chart === 'undefined') return;
             const isDark = document.documentElement.classList.contains('dark');
             Chart.defaults.color = isDark ? '#94a3b8' : '#334155'; // slate-400 / slate-700
             Chart.defaults.borderColor = isDark ? '#334155' : '#e2e8f0'; // slate-700 / slate-200
        }

        function renderThemeToggle(containerId = 'theme-toggle-container') {
             const container = document.getElementById(containerId);
             if (!container) return;
             
             const isDark = document.documentElement.classList.contains('dark');
             container.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <span class="text-lg text-slate-700 dark:text-slate-200">Modo Escuro</span>
                    <button id="theme-toggle-button" data-action="toggle-theme" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${isDark ? 'bg-sky-500' : 'bg-slate-600'}">
                        <span id="theme-toggle-knob" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${isDark ? 'translate-x-5' : 'translate-x-1'}"></span>
                    </button>
                </div>
             `;
        }
        // --- FIM FUN√á√ïES DE TEMA ---


        // --- Carregamento de Dados (Firestore) ---

        function loadAllData() {
            if (!userId || !dbPathPrefix) {
                console.warn("loadAllData chamado sem userId ou dbPathPrefix. Abortando.");
                return;
            }
            console.log("Carregando dados de:", dbPathPrefix);
            
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];

            if (!db) {
                console.log("...loadAllData: DB n√£o encontrado, reinicializando...");
                db = getFirestore(initializeApp(firebaseConfig));
            }
            
            const routinesQuery = collection(db, `${dbPathPrefix}/routines`);
            const unsubRoutines = onSnapshot(routinesQuery, (snapshot) => {
                allRoutines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render(); 
            }, (error) => console.error("Erro ao carregar rotinas:", error)); 
            unsubscribes.push(unsubRoutines); 

            const historyQuery = collection(db, `${dbPathPrefix}/routineHistory`);
            const unsubHistory = onSnapshot(historyQuery, (snapshot) => {
                routineHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar hist√≥rico:", error));
            unsubscribes.push(unsubHistory);

            const journalQuery = collection(db, `${dbPathPrefix}/journalEntries`);
            const unsubJournal = onSnapshot(journalQuery, (snapshot) => {
                journalEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar di√°rio:", error));
            unsubscribes.push(unsubJournal);

            const tasksQuery = collection(db, `${dbPathPrefix}/tasks`);
            const unsubTasks = onSnapshot(tasksQuery, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Tarefas carregadas:", allTasks.length);
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar tarefas:", error));
            unsubscribes.push(unsubTasks);

            const goalsQuery = collection(db, `${dbPathPrefix}/goals`);
            const unsubGoals = onSnapshot(goalsQuery, (snapshot) => {
                allGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar objetivos:", error));
            unsubscribes.push(unsubGoals);
            
            // NOVO: Carregar Alertas
            const alertsQuery = collection(db, `${dbPathPrefix}/alerts`);
            const unsubAlerts = onSnapshot(alertsQuery, (snapshot) => {
                allAlerts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (auth.currentUser) render();
            }, (error) => console.error("Erro ao carregar alertas:", error));
            unsubscribes.push(unsubAlerts);
        }

        // --- Fun√ß√µes de Renderiza√ß√£o (UI) ---

        function render() {
            // Destr√≥i gr√°ficos e calend√°rios antigos antes de mudar de p√°gina
            if (currentPage !== 'progress') {
                Object.values(window.myCharts).forEach(chart => chart.destroy());
                window.myCharts = {};
            }
            if (currentPage !== 'taskCalendar') {
                if (window.myCalendar) {
                    window.myCalendar.destroy();
                    window.myCalendar = null;
                }
            }

            const appContainer = document.getElementById('app-container');
            const header = document.getElementById('main-header');
            const bottomNav = document.getElementById('bottom-nav');
            
            if (!appContainer || !header || !bottomNav) return;
            
            // --- L√ìGICA DE RENDERIZA√á√ÉO ATUALIZADA ---
            switch(authState) {
                case 'VERIFICANDO':
                    // Mostra spinner
                    header.classList.add('hidden');
                    bottomNav.classList.add('hidden');
                    appContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
                            <p class="text-slate-600 dark:text-slate-400 text-xl mt-6 font-semibold">Verificando login...</p>
                        </div>`;
                    break;
                
                case 'DESLOGADO':
                    // Mostra tela de login
                    header.classList.add('hidden');
                    bottomNav.classList.add('hidden');
                    appContainer.innerHTML = renderLoginScreen();
                    // CORRE√á√ÉO: Chama o attachLoginListener AQUI
                    attachLoginListener();
                    break;
                
                case 'LOGADO':
                    // Mostra o app normal
                    header.classList.remove('hidden');
                    bottomNav.classList.remove('hidden'); 
                
                    const headerTitle = document.getElementById('header-title');
                    
                    switch (currentPage) {
                        case 'main':
                            if(headerTitle) headerTitle.innerText = "Painel Principal";
                            appContainer.innerHTML = renderMainDashboard();
                            renderTodayJournalEntry(); 
                            break;
                        case 'journalView':
                            if(headerTitle) headerTitle.innerText = "Meu Di√°rio";
                            appContainer.innerHTML = renderJournalView();
                            break;
                        case 'taskCalendar':
                            if(headerTitle) headerTitle.innerText = "Calend√°rio";
                            appContainer.innerHTML = renderTaskCalendar();
                            // Renderiza o calend√°rio DEPOIS que o HTML (canvas) est√° na p√°gina
                            // Usamos setTimeout para garantir que o DOM foi pintado
                            setTimeout(initializeFullCalendar, 0); 
                            break;
                        case 'progress':
                            if(headerTitle) headerTitle.innerText = "Meu Progresso";
                            appContainer.innerHTML = renderProgressPage();
                            // Renderiza os gr√°ficos DEPOIS que o HTML (canvas) est√° na p√°gina
                            setTimeout(renderAllCharts, 0);
                            break;
                    }
                    renderBottomNav(); // Atualiza o estado ativo da tab bar
                    renderAlertIcon(); // NOVO: Mostra/esconde o √≠cone de alerta
                    renderTaskClockIcon(); // NOVO: Mostra/colore o √≠cone de rel√≥gio
                    break;
            }
            // --- FIM DA L√ìGICA CONDICIONAL ---
            
            renderModal();
            
            // CORRE√á√ÉO (v2.2.3): Chama o Lucide aqui no final de CADA render()
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                 console.warn("Lucide n√£o definido no momento do render()");
                 // Tenta de novo em 50ms
                 setTimeout(() => {
                     if (typeof lucide !== 'undefined') lucide.createIcons();
                 }, 50);
            }
        }
        
        function renderLoginScreen() {
             let errorMessage = '';
             if (authError) {
                 if (authError.code === 'auth/unauthorized-domain') {
                     errorMessage = "ERRO: O dom√≠nio `fabioyshiaki.github.io` n√£o est√° na lista de 'Dom√≠nios autorizados' no seu painel do Firebase.";
                 } else if (authError.code === 'auth/operation-not-allowed') {
                     errorMessage = "ERRO: O login com 'Google' est√° desativado no seu painel do Firebase.";
                 } else if (authError.code === 'local-config-error') {
                     errorMessage = `ERRO: ${authError.message}`;
                 } else {
                     errorMessage = `Erro: ${authError.message} (c√≥digo: ${authError.code})`;
                 }
             }
        
             return `
                <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                    <i data-lucide="brain" class="w-24 h-24 text-sky-500 mb-6"></i>
                    <h1 class="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-3">Bem-vindo ao Foco TDAH</h1>
                    <p class="text-xl text-slate-600 dark:text-slate-300 mb-10 max-w-md">Para salvar seus dados e sincronizar entre dispositivos, fa√ßa o login.</p>
                    <button id="google-login-btn" class="flex items-center justify-center space-x-3 w-full max-w-sm bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-lg font-semibold py-4 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-slate-50 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.108-11.283-7.446l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C39.712 34.421 44 28.134 44 20c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        <span>Entrar com Google</span>
                    </button>
                    <!-- Local para mostrar erros de login -->
                    <p id="auth-error-message" class="text-red-600 font-bold mt-6 text-lg max-w-sm">${errorMessage}</p>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-10">Vers√£o: ${appVersion}</p>
                </div>
            `;
        }
        
        // --- NOVO: Fun√ß√µes para os √çcones do Header ---
        function isAlertActive(alert) {
            const createdAt = new Date(alert.createdAt);
            const now = new Date();
            const threeDaysInMs = 3 * 24 * 60 * 60 * 1000;
            return (now - createdAt) < threeDaysInMs;
        }
        
        function renderAlertIcon() {
            const icon = document.getElementById('alert-icon');
            if (!icon) return;
            
            const hasActiveAlerts = allAlerts.some(isAlertActive);
            
            if (hasActiveAlerts) {
                icon.classList.remove('hidden');
            } else {
                icon.classList.add('hidden');
            }
        }
        
        function renderTaskClockIcon() {
            const icon = document.getElementById('task-clock-icon');
            if (!icon) return;
            
            const now = new Date();
            
            // 1. Filtra apenas por tarefas futuras n√£o conclu√≠das
            const futureTasks = allTasks.filter(task => {
                if (task.completed) return false;
                
                const [year, month, day] = task.date.split('-').map(Number);
                let taskTime = [0, 0];
                if (task.time && task.time.includes(':')) {
                    taskTime = task.time.split(':').map(Number);
                }
                const taskDate = new Date(year, month - 1, day, taskTime[0], taskTime[1]);
                
                return taskDate.getTime() > now.getTime();
            });

            // 2. Se n√£o h√° tarefas futuras, esconde o √≠cone
            if (futureTasks.length === 0) {
                icon.classList.add('hidden');
                return;
            }

            // 3. Ordena para achar a mais pr√≥xima
            futureTasks.sort((a, b) => {
                const aDate = new Date(`${a.date}T${a.time || '00:00'}`);
                const bDate = new Date(`${b.date}T${b.time || '00:00'}`);
                return aDate - bDate;
            });

            // 4. Pega a mais urgente e sua cor
            const mostUrgentTask = futureTasks[0];
            const countdown = getTaskCountdown(mostUrgentTask);
            const colorName = countdown.color; // 'rose', 'orange', 'emerald'

            // 5. Remove classes de cor antigas e 'hidden'
            icon.classList.remove('hidden', 'text-rose-500', 'text-orange-500', 'text-emerald-500', 'text-slate-500');
            icon.classList.add('animate-pulse'); // Faz pulsar

            // 6. Adiciona a classe de cor correta
            switch(colorName) {
                case 'rose':
                    icon.classList.add('text-rose-500');
                    break;
                case 'orange':
                    icon.classList.add('text-orange-500');
                    break;
                case 'emerald':
                    icon.classList.add('text-emerald-500');
                    icon.classList.remove('animate-pulse'); // N√£o pulsa se for verde
                    break;
                default:
                    icon.classList.add('text-slate-500'); // Cor para 'Atrasada' (embora filtrado)
            }
        }
        // --- FIM ---

        function renderMainDashboard() {
            if (authState !== 'LOGADO') { 
                return `
                    <div class="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
                        <p class="text-slate-600 dark:text-slate-400 text-xl mt-6 font-semibold">Carregando...</p>
                    </div>`;
            }
        
            // --- MUDAN√áA v2.4.1: Ordem trocada ---
            return `
                <div class="p-4 flex flex-col gap-6">
                    <!-- Data -->
                    <div class="text-center">
                        <p id="header-date" class="text-sm text-slate-500 dark:text-slate-400 font-medium">${todayFullDate}</p>
                    </div>
                
                    <!-- 1. Alertas (NOVO) -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Alertas Ativos</h2>
                            <button data-action="open-modal" data-modal="addAlert" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="alerts-list" class="space-y-3">
                            ${renderActiveAlerts()}
                        </div>
                    </div>

                    <!-- 2. Pr√≥ximas Tarefas (MOVIDO PARA CIMA) -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Pr√≥ximas Tarefas</h2>
                            <button data-action="open-modal" data-modal="addTask" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="tasks-list" class="space-y-3">
                            ${renderUpcomingTasks()}
                        </div>
                    </div>

                    <!-- 3. Rotinas Di√°rias (MOVIDO PARA BAIXO) -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Rotinas</h2>
                            <button data-action="open-modal" data-modal="addRoutine" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="routines-list" class="space-y-3">
                            ${renderTodayRoutines()}
                        </div>
                    </div>

                    <!-- 4. Di√°rio -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-4">Di√°rio de Hoje</h2>
                        <textarea id="journal-textarea" class="w-full h-36 p-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 dark:placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors" placeholder="Como foi o seu dia?"></textarea>
                        <button id="save-journal-btn" class="mt-4 w-full bg-sky-600 text-white text-lg font-bold py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Di√°rio
                        </button>
                    </div>

                    <!-- 5. Objetivos (DE VOLTA!) -->
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Objetivos</h2>
                            <button data-action="open-modal" data-modal="addGoal" class="text-sky-600 hover:text-sky-800 dark:hover:text-sky-400 p-1 rounded-full hover:bg-sky-100 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="plus-circle" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <div id="goals-list" class="space-y-3">
                            ${renderActiveGoals()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- NOVO: Renderiza Alertas Ativos ---
        function renderActiveAlerts() {
            const activeAlerts = allAlerts.filter(isAlertActive);
            if (activeAlerts.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhum alerta ativo. Adicione um no bot√£o '+' acima.</p>`;
            }
            return activeAlerts.map(alert => {
                return `
                    <div class="flex items-center justify-between bg-rose-100 dark:bg-rose-900 border border-rose-200 dark:border-rose-700 p-4 rounded-lg">
                        <p class="text-xl font-medium text-rose-800 dark:text-rose-100">${alert.text}</p>
                        <!-- Sem bot√£o de excluir aqui, de prop√≥sito -->
                    </div>
                `;
            }).join('');
        }

        function renderTodayRoutines() {
            if (allRoutines.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhuma rotina criada. Adicione uma no bot√£o '+' acima.</p>`;
            }
            return allRoutines.map(routine => {
                const historyEntry = routineHistory.find(h => h.routineId === routine.id && h.date === todayString);
                const isCompleted = historyEntry?.completed || false;
                
                return `
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                        <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                            <input type="checkbox" 
                                   class="form-checkbox h-7 w-7 text-sky-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-sky-500" 
                                   ${isCompleted ? 'checked' : ''}
                                   data-action="toggle-routine"
                                   data-routine-id="${routine.id}"
                                   data-routine-name="${routine.name}"
                                   data-history-id="${historyEntry?.id || ''}">
                            <span class="${isCompleted ? 'line-through text-slate-400 dark:text-slate-500' : ''}">${routine.name}</span>
                        </label>
                        <button data-action="delete-routine" data-id="${routine.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderUpcomingTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const sevenDaysFromNow = new Date(today);
            sevenDaysFromNow.setDate(today.getDate() + 7);

            const upcomingTasks = allTasks.filter(task => {
                const [year, month, day] = task.date.split('-').map(Number);
                const taskDate = new Date(year, month - 1, day);
                return taskDate >= today && taskDate <= sevenDaysFromNow;
            });

            // Ordena por data (mais pr√≥xima primeiro)
            upcomingTasks.sort((a, b) => {
                // Constr√≥i datas completas para ordena√ß√£o
                const aDate = new Date(`${a.date}T${a.time || '00:00'}`);
                const bDate = new Date(`${b.date}T${b.time || '00:00'}`);
                return aDate - bDate;
            });

            if (upcomingTasks.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhuma tarefa para os pr√≥ximos 7 dias. Adicione uma no bot√£o '+' acima.</p>`;
            }
            
            return upcomingTasks.map(task => {
                // --- CORRE√á√ÉO v2.3.4: Chama a fun√ß√£o global ---
                const countdown = getTaskCountdown(task); 
                const isCompleted = task.completed;
                
                let colorClass = '';
                if (isCompleted) {
                     colorClass = 'bg-slate-100 text-slate-400 border-slate-200 dark:bg-slate-600 dark:text-slate-400 dark:border-slate-500';
                } else if (countdown.color === 'rose') {
                    colorClass = 'bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-800 dark:text-rose-200 dark:border-rose-700';
                } else if (countdown.color === 'orange') {
                    colorClass = 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-800 dark:text-orange-200 dark:border-orange-700';
                } else {
                    colorClass = 'bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-800 dark:text-emerald-200 dark:border-emerald-700';
                }
                
                // Adiciona o hor√°rio se ele existir
                const timeString = task.time ? `<span class="text-sm font-normal text-slate-500 dark:text-slate-400 ml-2">${task.time}</span>` : '';

                return `
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg ${isCompleted ? 'opacity-60' : ''}">
                        <span class="text-xl text-slate-800 dark:text-slate-100 ${isCompleted ? 'line-through' : ''}">${task.name}${timeString}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-sm px-2.5 py-0.5 rounded-full border ${colorClass}">
                                ${countdown.text}
                            </span>
                            <button data-action="toggle-task" data-id="${task.id}" data-completed="${isCompleted}" class="${isCompleted ? 'text-slate-400 hover:text-slate-600' : 'text-emerald-500 hover:text-emerald-700'} transition-colors">
                                <i data-lucide="${isCompleted ? 'check-circle' : 'circle'}" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActiveGoals() {
            const activeGoals = allGoals.filter(goal => !goal.completed);
            if (activeGoals.length === 0) {
                return `<p class="text-slate-500 dark:text-slate-400">Nenhum objetivo ativo. Adicione um no bot√£o '+' acima.</p>`;
            }
            return activeGoals.map(goal => `
                <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 p-4 rounded-lg">
                    <label class="flex items-center space-x-4 text-xl text-slate-800 dark:text-slate-100">
                        <input type="checkbox" 
                               class="form-checkbox h-7 w-7 text-emerald-600 rounded-md border-slate-300 dark:border-slate-500 focus:ring-emerald-500"
                               data-action="complete-goal"
                               data-id="${goal.id}"
                               data-name="${goal.name}">
                        <span>${goal.name}</span>
                    </label>
                    <button data-action="delete-goal" data-id="${goal.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function renderTodayJournalEntry() {
            const journalTextarea = document.getElementById('journal-textarea');
            if (journalTextarea) {
                const todayEntry = journalEntries.find(entry => entry.id === todayString);
                journalTextarea.value = todayEntry ? todayEntry.text : '';
            }
        }

        // --- Renderiza√ß√£o das P√°ginas do Menu ---
        
        // --- P√ÅGINA DE PROGRESSO (v2.6.1 - REORDENADA) ---
        function renderProgressPage() {
            return `
                <div class="p-4 flex flex-col gap-6">
                    ${renderRoutineCharts()} 
                    ${renderMonthlyStatsList()}
                    ${renderGoalStats()}
                </div>
            `;
        }
        
        // --- NOVO (v2.5.1): L√≥gica e Renderiza√ß√£o da Contagem Mensal por Rotina ---
        function aggregateMonthlyRoutineStats() {
            if (allRoutines.length === 0) return [];

            const statsByMonth = {}; // ex: { "2025-10": { monthName, routines: {} } }
            
            // 1. Encontra a primeira data de hist√≥rico
            const earliestEntry = routineHistory.sort((a, b) => a.date.localeCompare(b.date))[0];
            if (!earliestEntry) return []; // Sem hist√≥rico, sem estat√≠sticas

            let loopDate = new Date(earliestEntry.date + 'T00:00:00'); // Come√ßa do primeiro dia

            // 2. Itera dia por dia desde o in√≠cio at√© ONTEM
            while (loopDate < todayDate) {
                const dateString = getLocalYYYYMMDD(loopDate);
                const [year, month] = dateString.split('-');
                const monthKey = `${year}-${month}`;

                // Init month
                if (!statsByMonth[monthKey]) {
                    const monthDate = new Date(year, month - 1, 1);
                    statsByMonth[monthKey] = {
                        monthName: monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }),
                        monthKey: monthKey, // for sorting
                        routines: {}
                    };
                }
                
                const dayEntries = routineHistory.filter(h => h.date === dateString);

                // 3. Para cada dia, verifica APENAS as rotinas que j√° existiam
                const activeRoutinesOnDay = allRoutines.filter(r => new Date(r.createdAt) <= loopDate);

                activeRoutinesOnDay.forEach(routine => {
                    const routineId = routine.id;
                    const routineName = routine.name;

                    // Init routine for that month
                    if (!statsByMonth[monthKey].routines[routineId]) {
                        statsByMonth[monthKey].routines[routineId] = {
                            id: routineId,
                            name: routineName,
                            completed: 0,
                            missed: 0 // "Missed" s√≥ come√ßa a contar a partir daqui
                        };
                    }

                    // 4. Verifica se a rotina foi feita
                    const entry = dayEntries.find(h => h.routineId === routineId);
                    
                    if (entry && entry.completed) {
                        statsByMonth[monthKey].routines[routineId].completed++;
                    } else {
                        // Conta como "missed" se n√£o houver entrada ou se a entrada for "completed: false"
                        statsByMonth[monthKey].routines[routineId].missed++;
                    }
                });
                
                // Incrementa o dia do loop
                loopDate.setDate(loopDate.getDate() + 1);
            }
            
            // Converte para array e sort
            const statsArray = Object.values(statsByMonth);
            // Sort months (newest first)
            statsArray.sort((a, b) => b.monthKey.localeCompare(a.monthKey));
            
            // Convert nested routines to array and sort (most completed first)
            statsArray.forEach(month => {
                month.routines = Object.values(month.routines);
                month.routines.sort((a, b) => b.completed - a.completed);
            });
            
            return statsArray;
        }

        function renderMonthlyStatsList() {
            const statsArray = aggregateMonthlyRoutineStats();

            let html = `
                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-6">Contagem Mensal por Rotina</h2>
                    <div class="space-y-6">
            `;

            if (statsArray.length === 0) {
                html += `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum hist√≥rico de rotina encontrado. (Os dados aparecem no dia seguinte)</p>`;
            } else {
                html += statsArray.map(monthStats => {
                    return `
                        <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                            <h3 class="text-xl font-semibold text-sky-700 dark:text-sky-500 capitalize mb-4">${monthStats.monthName}</h3>
                            <div class="space-y-3">
                            ${monthStats.routines.map(routine => {
                                return `
                                <div class="flex justify-between items-center bg-white dark:bg-slate-700 p-3 rounded-md shadow-sm">
                                    <span class="text-slate-800 dark:text-slate-100 font-medium text-lg">${routine.name}</span>
                                    <div class="flex gap-4">
                                        <div class="text-center">
                                            <p class="text-xl font-bold text-emerald-500">${routine.completed}</p>
                                            <p class="text-xs text-slate-500 dark:text-slate-400">OK</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-xl font-bold text-rose-500">${routine.missed}</p>
                                            <p class="text-xs text-slate-500 dark:text-slate-400">N√£o</p>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            html += `</div></div>`;
            return html;
        }
        // --- FIM DA NOVA SE√á√ÉO ---

        // --- P√ÅGINA DE ESTAT√çSTICAS (v2.6.1) ---
        function renderRoutineCharts() {
            // Esta fun√ß√£o agora apenas desenha os containers dos gr√°ficos
            return `
                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-6">Estat√≠sticas de Rotinas</h2>
                    <div class="space-y-8">
                        
                        <!-- Gr√°fico de Hoje -->
                        <div>
                            <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Hoje</h3>
                            <div class="h-64 flex items-center justify-center">
                                <canvas id="todayChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- GR√ÅFICOS ANTIGOS DE VOLTA (v2.6.1) -->
                        <div>
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">√öltimos 7 Dias</h3>
                            <div class="h-64">
                                <canvas id="weekChart"></canvas>
                            </div>
                        </div>
                        
                        <div>
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">√öltimas 4 Semanas</h3>
                            <div class="h-64">
                                <canvas id="monthChart"></canvas>
                            </div>
                        </div>
                        
                        <div>
                             <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Este Ano</h3>
                            <div class="h-64">
                                <canvas id="yearChart"></canvas>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // --- NOVAS FUN√á√ïES DE GR√ÅFICOS ---
        
        function renderAllCharts() {
            if (typeof Chart === 'undefined') {
                 console.error("Chart.js n√£o foi carregado.");
                 return;
            }
            // Limpa gr√°ficos antigos
            Object.values(window.myCharts).forEach(chart => chart.destroy());
            window.myCharts = {};
            
            renderTodayChart();
            renderWeekChart();
            renderMonthChart();
            renderYearChart();
        }
        
        // --- MUDAN√áA v2.4.4: Adiciona texto no centro ---
        function renderTodayChart() {
            const ctx = document.getElementById('todayChart')?.getContext('2d');
            if (!ctx) return;
            
            // CORRE√á√ÉO v2.6.1: Calcula total baseado em rotinas ativas *hoje*
            const activeRoutinesToday = allRoutines.filter(r => new Date(r.createdAt) <= todayDate);
            const total = activeRoutinesToday.length;

            const todayEntries = routineHistory.filter(h => h.date === todayString);
            const completed = todayEntries.filter(h => h.completed).length;
            const pending = total - completed;
            
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            const percentageText = `${percentage}%`;
            const isDark = document.documentElement.classList.contains('dark');

            if (window.myCharts.todayChart) window.myCharts.todayChart.destroy();
            
            window.myCharts.todayChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Conclu√≠das', 'Pendentes'],
                    datasets: [{
                        data: [completed, pending < 0 ? 0 : pending],
                        backgroundColor: [
                            '#0ea5e9', // sky-500
                            isDark ? '#334155' : '#e2e8f0' // slate-700 / slate-200
                        ],
                        borderColor: isDark ? '#1e293b' : '#ffffff', // bg-slate-800 ou bg-white
                        borderWidth: 4,
                        cutout: '70%' // Aumentar o buraco
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { // Legenda (Conclu√≠das, Pendentes)
                            position: 'bottom',
                            labels: {
                                padding: 20
                            }
                        }
                    }
                },
                // Plugin customizado para desenhar o texto no centro
                plugins: [{
                    id: 'doughnutText',
                    afterDraw(chart, args, options) {
                        const { ctx } = chart;
                        const centerX = chart.getDatasetMeta(0).data[0].x;
                        const centerY = chart.getDatasetMeta(0).data[0].y;
                        
                        ctx.save();
                        
                        // Texto Principal (Porcentagem)
                        ctx.font = 'bold 3rem Inter, sans-serif'; // 3rem = 48px
                        ctx.fillStyle = isDark ? '#f1f5f9' : '#1e293b'; // slate-100 / slate-800
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(percentageText, centerX, centerY - 10); // Um-pouco para cima
                        
                        // Sub-texto ("Conclu√≠do")
                        ctx.font = '600 1rem Inter, sans-serif'; // 1rem = 16px
                        ctx.fillStyle = isDark ? '#94a3b8' : '#64748b'; // slate-400 / slate-500
                        ctx.fillText('Conclu√≠do', centerX, centerY + 25); // Um-pouco para baixo
                        
                        ctx.restore();
                    }
                }]
            });
        }
        
        // --- MUDAN√áA v2.6.1: L√≥gica de 'total' corrigida + Interatividade ---
        function renderWeekChart() {
            const ctx = document.getElementById('weekChart')?.getContext('2d');
            if (!ctx) return;

            const labels = [];
            const data = [];
            const dayDates = []; // Store the actual dates for the onClick
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(todayDate); // Start from today
                date.setDate(date.getDate() - i); // Go back i days
                date.setHours(0,0,0,0);
                
                const dateString = getLocalYYYYMMDD(date);
                dayDates.push(dateString); // Save the YYYY-MM-DD string
                
                const dayLabel = (i === 0) ? 'Hoje' : (i === 1) ? 'Ontem' : dayNames[date.getDay()];
                labels.push(dayLabel);
                
                // --- BUG FIX ---
                // 1. Find routines that *existed* on this day
                const activeRoutinesOnDay = allRoutines.filter(r => new Date(r.createdAt) <= date);
                const totalPossible = activeRoutinesOnDay.length;
                
                // 2. Find how many were completed
                const completed = routineHistory.filter(h => h.date === dateString && h.completed).length;
                
                // 3. Calculate percentage based on the correct total
                const percentage = (totalPossible > 0) ? Math.round((completed / totalPossible) * 100) : 0;
                data.push(percentage);
            }

            if (window.myCharts.weekChart) window.myCharts.weekChart.destroy();

            window.myCharts.weekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: data,
                        backgroundColor: '#0ea5e9', // sky-500
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    // --- NEW FEATURE: Click handler ---
                    onClick: (e) => {
                        const points = window.myCharts.weekChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const index = firstPoint.index;
                            const dateStr = dayDates[index]; // Get the YYYY-MM-DD string
                            
                            selectedDate = dateStr;
                            currentModal = 'dayRoutineStats';
                            renderModal();
                        }
                    }
                }
            });
        }
        
        // --- MUDAN√áA v2.6.1: L√≥gica de 'total' corrigida ---
        function renderMonthChart() {
            const ctx = document.getElementById('monthChart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = ['Sem 4', 'Sem 3', 'Sem 2', 'Sem 1 (Atual)'];
            const data = [];

            for (let w = 3; w >= 0; w--) {
                const weekStart = new Date(todayDate);
                weekStart.setDate(weekStart.getDate() - (w * 7) - todayDate.getDay()); // In√≠cio da semana (Dom)
                weekStart.setHours(0,0,0,0);
                
                let completedCount = 0;
                let totalPossibleInWeek = 0; // <-- NOVO

                for (let d = 0; d < 7; d++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + d);
                    
                    // S√≥ conta dias at√© "hoje"
                    if (date <= todayDate) {
                        const dateString = getLocalYYYYMMDD(date);
                        
                        // Conta quantas rotinas *existiam* nesse dia
                        const activeRoutinesOnDay = allRoutines.filter(r => new Date(r.createdAt) <= date).length;
                        totalPossibleInWeek += activeRoutinesOnDay;
                        
                        // Conta quantas foram *completadas* nesse dia
                        const completedOnDay = routineHistory.filter(h => h.date === dateString && h.completed).length;
                        completedCount += completedOnDay;
                    }
                }
                
                const percentage = totalPossibleInWeek > 0 ? Math.round((completedCount / totalPossibleInWeek) * 100) : 0;
                data.push(percentage);
            }

            if (window.myCharts.monthChart) window.myCharts.monthChart.destroy();
            window.myCharts.monthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: data,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // --- MUDAN√áA v2.6.1: L√≥gica de 'total' corrigida ---
        function renderYearChart() {
            const ctx = document.getElementById('yearChart')?.getContext('2d');
            if (!ctx) return;

            const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const completedData = Array(12).fill(0);
            const totalPossibleData = Array(12).fill(0);
            
            const currentYear = todayDate.getFullYear();
            const currentMonth = todayDate.getMonth();

            // Pega entradas de rotina apenas deste ano
            const yearEntries = routineHistory.filter(h => h.date.startsWith(currentYear));

            yearEntries.forEach(h => {
                const month = parseInt(h.date.split('-')[1], 10) - 1; // 0-11
                if (h.completed) {
                    completedData[month]++; // Soma conclus√µes
                }
            });
            
            // Calcula o total poss√≠vel para cada m√™s
            for (let month = 0; month <= 11; month++) {
                if (month > currentMonth) break; // N√£o calcula para meses futuros
                
                const daysInThisMonth = (month === currentMonth) 
                    ? todayDate.getDate() // M√™s atual: conta s√≥ at√© hoje
                    : new Date(currentYear, month + 1, 0).getDate(); // M√™s passado: conta cheio
                
                let totalPossibleInMonth = 0;
                for (let day = 1; day <= daysInThisMonth; day++) {
                    const date = new Date(currentYear, month, day);
                    date.setHours(0,0,0,0);
                    
                    totalPossibleInMonth += allRoutines.filter(r => new Date(r.createdAt) <= date).length;
                }
                totalPossibleData[month] = totalPossibleInMonth;
            }
            
            // Calcula porcentagem
            const percentageData = completedData.map((completedCount, month) => {
                const totalPossible = totalPossibleData[month];
                return totalPossible > 0 ? Math.round((completedCount / totalPossible) * 100) : 0;
            });

            if (window.myCharts.yearChart) window.myCharts.yearChart.destroy();
            window.myCharts.yearChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Conclu√≠da',
                        data: percentageData,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }


        // --- DI√ÅRIO COM ACORDE√ÉO (v2.0.0) ---
        function renderJournalView() {
            const entriesByMonth = {};
            journalEntries.forEach(entry => {
                const [year, month] = entry.id.split('-'); // YYYY-MM-DD
                const monthKey = `${year}-${month}`;
                if (!entriesByMonth[monthKey]) {
                    entriesByMonth[monthKey] = [];
                }
                entriesByMonth[monthKey].push(entry);
            });

            const sortedMonths = Object.keys(entriesByMonth).sort().reverse();
            
            let html = `<div class="p-4 flex flex-col gap-4">`;

            if (sortedMonths.length === 0) {
                 html += `<p class="text-slate-500 dark:text-slate-400 text-center mt-8 text-lg">Nenhuma entrada no di√°rio ainda.</p>`;
            }

            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                html += `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
                            <button data-action="toggle-month" data-month-id="month-${monthKey}" class="w-full flex justify-between items-center p-6">
                                <h3 class="text-2xl font-semibold text-sky-700 dark:text-sky-500 capitalize">${monthName}</h3>
                                <i data-lucide="chevron-down" class="text-slate-500 transition-transform"></i>
                            </button>
                            <div id="month-${monthKey}" class="hidden space-y-5 px-6 pb-6 pt-2 border-t border-slate-200 dark:border-slate-700">`;
                
                entriesByMonth[monthKey].sort((a, b) => b.id.localeCompare(a.id)).forEach(entry => {
                    const [y, m, d] = entry.id.split('-').map(Number);
                    const entryDate = new Date(y, m - 1, d).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
                    html += `
                        <div class="border-b border-slate-200 dark:border-slate-700 pb-4 last:border-b-0">
                            <p class="text-lg font-semibold text-slate-800 dark:text-slate-100">${entryDate}</p>
                            <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap mt-1">${entry.text}</p>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            html += `</div>`;
            return html;
        }

        // --- CALEND√ÅRIO SIMPLES (v2.3.0) ---
        function renderTaskCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-11
            const monthName = currentCalendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Dom, 1=Seg, ...
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            let html = `
                <div class="p-4">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-5xl mx-auto overflow-hidden">
                        <!-- Header do Calend√°rio -->
                        <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                            <button data-action="calendar-prev" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 dark:hover:text-slate-100 transition-colors">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                            </button>
                            <h2 class="text-2xl font-bold text-sky-700 dark:text-sky-500 capitalize">${monthName}</h2>
                            <button data-action="calendar-next" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 dark:hover:text-slate-100 transition-colors">
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <!-- Grid dos Dias -->
                        <div class="grid grid-cols-7">
                            <!-- Cabe√ßalho dos dias da semana -->
                            ${daysOfWeek.map(day => `<div class="text-center font-semibold text-slate-500 dark:text-slate-400 p-2 border-b border-slate-200 dark:border-slate-700 text-sm">${day}</div>`).join('')}
                            
                            <!-- Dias em branco (in√≠cio) -->
                            ${Array(firstDayOfMonth).fill('').map(() => `<div class="border-r border-b border-slate-200 dark:border-slate-700 h-24 md:h-28"></div>`).join('')}

                            <!-- Dias do m√™s -->
                            ${Array.from({ length: daysInMonth }, (_, i) => i + 1).map(day => {
                                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const tasksForDay = allTasks.filter(task => task.date === dateStr);
                                const isToday = dateStr === todayString;
                                
                                // --- L√ìGICA DE COR DA BOLINHA (v2.3.5) ---
                                let dotColor = 'bg-sky-500'; // Default (azul)
                                const futureTasks = tasksForDay.filter(t => !t.completed);
                                if (futureTasks.length > 0) {
                                    // Verifica a mais urgente
                                    const countdown = getTaskCountdown(futureTasks[0]);
                                    if (countdown.color === 'rose') dotColor = 'bg-rose-500';
                                    else if (countdown.color === 'orange') dotColor = 'bg-orange-500';
                                    else if (countdown.color === 'emerald') dotColor = 'bg-emerald-500';
                                }
                                const allDone = tasksForDay.length > 0 && futureTasks.length === 0;
                                if (allDone) dotColor = 'bg-emerald-500';
                                // --- FIM DA L√ìGICA DE COR ---

                                return `
                                    <div data-action="view-day-tasks" data-date="${dateStr}" class="border-r border-b border-slate-200 dark:border-slate-700 h-24 md:h-28 p-1.5 overflow-y-auto relative hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
                                        <div class="font-semibold text-sm ${isToday ? 'bg-sky-600 text-white rounded-full w-6 h-6 flex items-center justify-center' : 'text-slate-700 dark:text-slate-300'}">${day}</div>
                                        <div class="mt-1 space-y-1">
                                            ${tasksForDay.map(task => `
                                                <div class="w-full h-1.5 rounded ${task.completed ? 'bg-emerald-500' : dotColor}"></div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }
        
        // --- CALEND√ÅRIO FULLCALENDAR (REMOVIDO) ---
        function initializeFullCalendar() {
            // Esta fun√ß√£o est√° vazia agora
        }
        
        // --- P√ÅGINA DE OBJETIVOS (v2.2.2 - CORRE√á√ÉO) ---
        function renderGoalStats() {
            const activeGoals = allGoals.filter(goal => !goal.completed);
            const completedGoals = allGoals.filter(goal => goal.completed);

            return `
                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-slate-100">Objetivos</h2>
                    </div>
                    
                    <!-- Objetivos Ativos (MODO LEITURA) -->
                    <div>
                        <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Ativos</h3>
                        <div class="space-y-4">
                            ${activeGoals.length > 0 ? activeGoals.map(goal => `
                                <p class="text-xl text-slate-700 dark:text-slate-200 p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg">${goal.name}</p>
                            `).join('') : `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum objetivo ativo.</p>`}
                        </div>
                    </div>
                    
                    <!-- Objetivos Conclu√≠dos -->
                    <div class="mt-8">
                        <h3 class="text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4">Conclu√≠dos</h3>
                        <div class="space-y-4">
                            ${completedGoals.length > 0 ? completedGoals.map(goal => `
                                <p class="text-xl text-slate-400 dark:text-slate-500 line-through p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg">${goal.name}</p>
                            `).join('') : `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhum objetivo conclu√≠do ainda.</p>`}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Renderiza a Tab Bar ---
        function renderBottomNav() {
            const nav = document.getElementById('bottom-nav');
            if (!nav) return;
            
            // --- MUDAN√áA v2.4.2 ---
            const tabs = [
                { id: 'main', icon: 'layout-dashboard', label: 'In√≠cio', action: `nav-main` },
                { id: 'journalView', icon: 'book-open', label: 'Di√°rio', action: `nav-journalView` },
                { id: 'taskCalendar', icon: 'calendar-days', label: 'Calend√°rio', action: `nav-taskCalendar` },
                { id: 'progress', icon: 'pie-chart', label: 'Progresso', action: `nav-progress` },
                { id: 'settings', icon: 'settings', label: 'Ajustes', action: `open-settings` } // <-- NOVO ITEM
            ];
            
            nav.innerHTML = tabs.map(tab => {
                // "Settings" n√£o √© uma p√°gina, por isso nunca est√° "ativa"
                const isActive = (currentPage === tab.id) && (tab.action.startsWith('nav-'));
                const activeClass = isActive ? 'text-sky-500 dark:text-sky-400' : 'text-slate-500 dark:text-slate-400';
                
                return `
                    <button data-action="${tab.action}" class="flex flex-col items-center justify-center p-2 w-full ${activeClass} transition-colors">
                        <i data-lucide="${tab.icon}" class="w-6 h-6"></i>
                        <span class="text-xs font-semibold">${tab.label}</span>
                    </button>
                `;
            }).join('');
        }

        // --- Renderiza√ß√£o do Modal ---

        function renderModal() {
            const modalContainer = document.getElementById('modal-container');
            if (!currentModal) {
                selectedDate = null; // Limpa a data selecionada
                taskForReminder = null; // Limpa a tarefa do lembrete
                modalContainer.innerHTML = '';
                return;
            }

            let modalTitle = '';
            let modalContent = '';

            switch (currentModal) {
                case 'addRoutine':
                    modalTitle = 'Nova Rotina Di√°ria';
                    modalContent = `
                        <label for="routine-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome da Rotina</label>
                        <input type="text" id="routine-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Tomar caf√© da manh√£">
                        <button id="save-routine-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Rotina
                        </button>
                    `;
                    break;
                case 'addAlert': // <-- NOVO MODAL
                    modalTitle = 'Novo Alerta';
                    modalContent = `
                        <label for="alert-text" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Mensagem do Alerta</label>
                        <textarea id="alert-text" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" rows="3" placeholder="Ex: Lembrar de tomar o rem√©dio"></textarea>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Este alerta ficar√° vis√≠vel no painel por 3 dias.</p>
                        <button id="save-alert-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Alerta
                        </button>
                    `;
                    break;
                case 'addTask':
                    modalTitle = 'Nova Tarefa Agendada';
                    modalContent = `
                        <label for="task-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome da Tarefa</label>
                        <input type="text" id="task-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Consulta m√©dica">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="task-date" class="block text-lg font-medium text-slate-700 dark:text-slate-200 mt-4">Data</label>
                                <input type="date" id="task-date" value="${selectedDate || todayString}" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div>
                                <label for="task-time" class="block text-lg font-medium text-slate-700 dark:text-slate-200 mt-4">Hora</label>
                                <input type="time" id="task-time" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </div>
                        </div>
                        
                        <button id="save-task-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Tarefa
                        </button>
                    `;
                    break;
                case 'addGoal':
                    modalTitle = 'Novo Objetivo';
                    modalContent = `
                        <label for="goal-name" class="block text-lg font-medium text-slate-700 dark:text-slate-200">Nome do Objetivo</label>
                        <input type="text" id="goal-name" class="mt-2 block w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-lg p-3 text-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Ex: Ler 1 livro este m√™s">
                        <button id="save-goal-btn" class="mt-6 w-full bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            Salvar Objetivo
                        </button>
                    `;
                    break;
                case 'settings':
                    modalTitle = 'Configura√ß√µes';
                    // Renderiza a lista de alertas para gerenciamento
                    const allAlertsHtml = allAlerts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(alert => {
                        const isActive = isAlertActive(alert);
                        return `
                            <div class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
                                <span class="text-slate-800 dark:text-slate-100 ${!isActive ? 'line-through text-slate-400 dark:text-slate-500' : ''}">${alert.text}</span>
                                <button data-action="delete-alert" data-id="${alert.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    modalContent = `
                        <div class="space-y-6">
                            <!-- Status do Usu√°rio -->
                            <div>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Usu√°rio Logado</p>
                                <p class="text-lg font-semibold text-slate-800 dark:text-slate-100">${currentUser ? (currentUser.displayName || currentUser.email) : 'Deslogado'}</p>
                            </div>
                            
                            <!-- Bot√£o de Tema -->
                            <div id="theme-toggle-container-modal">
                                <!-- O bot√£o de tema ser√° renderizado aqui -->
                            </div>
                            
                            <!-- Gerenciar Alertas -->
                            <div>
                                <p class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-3">Gerenciar Alertas</p>
                                <div class="max-h-48 overflow-y-auto space-y-2 pr-2">
                                     ${allAlerts.length > 0 ? allAlertsHtml : '<p class="text-sm text-slate-500 dark:text-slate-400">Nenhum alerta criado.</p>'}
                                </div>
                            </div>
                            
                            <!-- Bot√£o de Sair -->
                            <div>
                                <a href="#" data-action="auth-logout" class="flex items-center justify-center space-x-3 w-full bg-rose-600 text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-rose-700">
                                    <i data-lucide="log-out" class="w-5 h-5"></i>
                                    <span>Sair (Logout)</span>
                                </a>
                            </div>
                            
                            <!-- Vers√£o do App -->
                            <p class="text-center text-sm text-slate-400 dark:text-slate-500">Vers√£o: ${appVersion}</p>
                        </div>
                    `;
                    break;
                case 'taskDayView': // <-- NOVO MODAL (do Calend√°rio)
                    if (!selectedDate) {
                        currentModal = null;
                        return;
                    }
                    const tasksForDay = allTasks
                        .filter(t => t.date === selectedDate)
                        .sort((a,b) => (a.time || "00:00").localeCompare(b.time || "00:00")); // Ordena por hora
                        
                    modalTitle = `Tarefas de ${new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' })}`;
                    
                    if (tasksForDay.length === 0) {
                         modalContent = `<p class="text-slate-500 dark:text-slate-400 text-lg">Nenhuma tarefa para este dia.</p>`;
                    } else {
                         modalContent = tasksForDay.map(task => {
                             const isCompleted = task.completed;
                             const timeString = task.time ? `<span class="text-sm font-semibold text-sky-600 dark:text-sky-400 mr-3">${task.time}</span>` : '';
                             
                             return `
                                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                    <div class="flex items-center">
                                        ${timeString}
                                        <span class="text-lg text-slate-800 dark:text-slate-100 ${isCompleted ? 'line-through text-slate-400 dark:text-slate-500' : ''}">${task.name}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button data-action="toggle-task" data-id="${task.id}" data-completed="${isCompleted}" class="${isCompleted ? 'text-slate-400 hover:text-slate-600' : 'text-emerald-500 hover:text-emerald-700'} transition-colors">
                                            <i data-lucide="${isCompleted ? 'check-circle' : 'circle'}" class="w-6 h-6"></i>
                                        </button>
                                        <button data-action="delete-task" data-id="${task.id}" class="text-slate-400 dark:text-slate-500 hover:text-rose-500 transition-colors">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                             `;
                         }).join('<div class="h-2"></div>'); // Espa√ßador
                    }
                    // Adiciona bot√£o para criar nova tarefa NESSE dia
                    modalContent += `
                        <button data-action="add-task-for-date" class="mt-6 w-full flex items-center justify-center space-x-2 bg-sky-600 text-white font-bold text-lg py-3 px-4 rounded-lg hover:bg-sky-700 shadow-md hover:shadow-lg transition-all">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                            <span>Nova Tarefa</span>
                        </button>
                    `;
                    break;
                // --- NOVO MODAL DE LEMBRETE (v2.6.0) ---
                case 'taskReminder':
                    if (!taskForReminder) {
                        currentModal = null;
                        return;
                    }
                    const isFinalReminder = taskForReminder.level === 10;
                    modalTitle = `Lembrete de Tarefa!`;
                    modalContent = `
                        <div class="space-y-6">
                            <h4 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">${taskForReminder.name}</h4>
                            <p class="text-lg text-rose-600 dark:text-rose-400 font-bold flex items-center">
                                <i data-lucide="clock" class="inline-block w-5 h-5 mr-2"></i>
                                Come√ßa em ${taskForReminder.level} minutos (√†s ${taskForReminder.time})
                            </p>
                            
                            <!-- Bot√£o de Concluir -->
                            <button data-action="toggle-task" data-id="${taskForReminder.id}" data-completed="false" class="bg-emerald-600 hover:bg-emerald-700 flex items-center justify-center space-x-3 w-full text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                                <span>Marcar como Conclu√≠da</span>
                            </button>
                            
                            <!-- Bot√£o de Fechar / Cancelar -->
                            ${isFinalReminder ? `
                            <button data-action="delete-task" data-id="${taskForReminder.id}" class="flex items-center justify-center space-x-3 w-full bg-rose-600 text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-rose-700">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <span>Cancelar Tarefa</span>
                            </button>
                            ` : `
                            <button data-action="close-modal" class="flex items-center justify-center space-x-3 w-full bg-slate-500 text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all hover:bg-slate-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                                <span>Fechar</span>
                            </button>
                            `}
                        </div>
                    `;
                    break;
                // --- NOVO MODAL DE ESTAT√çSTICAS (v2.6.1) ---
                case 'dayRoutineStats': {
                    if (!selectedDate) {
                        currentModal = null;
                        return;
                    }
                    
                    const date = new Date(selectedDate + 'T00:00:00'); // Ajuste para fuso hor√°rio
                    const dayName = date.toLocaleDateString('pt-BR', { weekday: 'long', timeZone: 'UTC' });
                    modalTitle = `Estat√≠sticas de ${dayName}`;
                    
                    // L√≥gica de c√°lculo (corrigida para o bug 400%)
                    const activeRoutinesOnDay = allRoutines.filter(r => new Date(r.createdAt) <= date);
                    const totalPossible = activeRoutinesOnDay.length;
                    const dayEntries = routineHistory.filter(h => h.date === selectedDate);
                    const completedCount = dayEntries.filter(h => h.completed).length;
                    const percentage = totalPossible > 0 ? Math.round((completedCount / totalPossible) * 100) : 0;
                    
                    let detailsHtml = '';
                    if (activeRoutinesOnDay.length === 0) {
                        detailsHtml = '<p class="text-sm text-slate-500 dark:text-slate-400">Nenhuma rotina cadastrada neste dia.</p>';
                    } else {
                        detailsHtml = activeRoutinesOnDay.map(routine => {
                            const entry = dayEntries.find(h => h.routineId === routine.id);
                            const isCompleted = entry && entry.completed;
                            return `
                                <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                    <i data-lucide="${isCompleted ? 'check-circle-2' : 'x-circle'}" class="w-5 h-5 ${isCompleted ? 'text-emerald-500' : 'text-rose-500'} flex-shrink-0"></i>
                                    <span class="text-slate-700 dark:text-slate-200 text-lg ${!isCompleted ? 'opacity-60' : ''}">${routine.name}</span>
                                </div>
                            `;
                        }).join('');
                    }

                    modalContent = `
                        <div class="space-y-4">
                            <div class="text-center">
                                <p class="text-6xl font-bold text-sky-600 dark:text-sky-400">${percentage}%</p>
                                <p class="text-lg text-slate-600 dark:text-slate-400 font-semibold">${completedCount} de ${totalPossible} rotinas</p>
                            </div>
                            <div class="space-y-2 max-h-64 overflow-y-auto pr-2">
                                ${detailsHtml}
                            </div>
                        </div>
                    `;
                    break;
                }
            }

            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-40" data-action="close-modal-bg"></div>
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-2xl shadow-2xl">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-3xl font-bold text-slate-800 dark:text-slate-100">${modalTitle}</h3>
                            <button data-action="close-modal" class="text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 ${currentModal === 'taskReminder' && taskForReminder && taskForReminder.level === 10 ? 'hidden' : ''}">
                                <i data-lucide="x" class="w-8 h-8"></i>
                            </button>
                        </div>
                        <div>
                            ${modalContent}
                        </div>
                    </div>
                </div>
            `;
            
            // Renderiza o bot√£o de tema *dentro* do modal
            if (currentModal === 'settings') {
                renderThemeToggle('theme-toggle-container-modal');
            }
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- Navega√ß√£o e Event Listeners ---
        
        // --- CORRE√á√ÉO v2.3.1: Listener de login separado ---
        function attachLoginListener() {
             const loginBtn = document.getElementById('google-login-btn');
             if (loginBtn) {
                // Remove listener antigo para evitar duplicatas
                loginBtn.removeEventListener('click', handleGoogleLogin); 
                // Adiciona o novo listener
                loginBtn.addEventListener('click', handleGoogleLogin);
                console.log("Listener de login anexado diretamente ao bot√£o.");
             } else {
                // Isso pode acontecer se o render() for chamado
                // enquanto o authState ainda √© 'LOGADO' ou 'VERIFICANDO'
                console.warn("Bot√£o de login n√£o encontrado para anexar listener.");
             }
        }
        
        function setupEventListeners() {
            // Listener principal para A√á√ïES
            document.body.addEventListener('click', (e) => {
                
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;
                
                // A√ß√£o de Logout
                if (action === 'auth-logout') {
                    currentModal = null; // Fecha o modal de settings
                    handleLogout();
                    return;
                }
                
                // A√ß√£o de Mudar Tema
                if (action === 'toggle-theme') {
                    setTheme(currentTheme === 'light' ? 'dark' : 'light');
                    return;
                }
                
                // A√ß√£o de Acorde√£o do Di√°rio ou Progresso
                if (action === 'toggle-month' || action === 'toggle-day-stats') {
                    const id = target.dataset.monthId || target.dataset.dayId;
                    const content = document.getElementById(id);
                    const icon = target.querySelector('i[data-lucide="chevron-down"]');
                    if (content) content.classList.toggle('hidden');
                    if (icon) icon.classList.toggle('rotate-180');
                    // CORRE√á√ÉO v2.6.1: Recarrega √≠cones dentro do acorde√£o
                    if (content && !content.classList.contains('hidden')) {
                        setTimeout(() => {
                           if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 50);
                    }
                    return;
                }

                // A√ß√µes do Menu (agora Tab Bar)
                if (action.startsWith('nav-')) {
                    currentPage = action.split('-')[1];
                    render(); // Renderiza a nova p√°gina e atualiza a tab bar
                }
                
                // A√ß√£o do novo bot√£o de Configura√ß√µes
                if (action === 'open-settings') {
                    currentPage = 'main'; // Define a p√°gina principal como "ativa"
                    currentModal = 'settings';
                    renderModal();
                }

                // A√ß√µes do Modal
                if (action === 'open-modal') {
                    currentModal = target.dataset.modal;
                    renderModal();
                }
                if (action === 'close-modal') {
                    currentModal = null;
                    renderModal();
                }
                
                // NOVO: A√ß√£o de clique no dia do calend√°rio
                if (action === 'view-day-tasks') {
                    selectedDate = target.dataset.date;
                    currentModal = 'taskDayView';
                    renderModal();
                }
                
                // NOVO: Bot√£o de adicionar tarefa de dentro do modal do dia
                if (action === 'add-task-for-date') {
                    currentModal = 'addTask'; // Reusa o modal de add tarefa
                    // selectedDate j√° est√° setado
                    renderModal();
                }

                // A√ß√µes de Salvar (CRUD)
                if (action === 'save-routine') handleAddRoutine();
                if (action ==='save-task') handleAddTask();
                if (action === 'save-goal') handleAddGoal();
                if (action === 'save-alert') handleAddAlert(); // <-- NOVO

                // A√ß√µes de Itens (CRUD)
                if (action === 'toggle-routine') handleToggleRoutine(target);
                if (action === 'delete-routine') handleDeleteRoutine(target.dataset.id);
                if (action === 'toggle-task') handleToggleTask(target.dataset.id, target.dataset.completed === 'true'); // <-- MUDADO
                if (action === 'delete-task') handleDeleteTask(target.dataset.id); // <-- MUDADO
                if (action === 'complete-goal') handleCompleteGoal(target); // <-- MUDADO
                if (action === 'delete-goal') handleDeleteGoal(target.dataset.id);
                if (action === 'delete-alert') handleDeleteAlert(target.dataset.id); // <-- NOVO
                
                // A√ß√µes do Calend√°rio
                if (action === 'calendar-prev') {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                    render(); // Recria a p√°gina inteira
                }
                if (action === 'calendar-next') {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                    render(); // Recria a p√°gina inteira
                }
            });
            
            // Listener separado para os bot√µes de salvar (pois eles s√£o recriados)
            document.body.addEventListener('click', e => {
                if (e.target.id === 'save-journal-btn') {
                    handleSaveJournal();
                }
                if (e.target.id === 'save-routine-btn') {
                    handleAddRoutine();
                }
                if (e.target.id === 'save-task-btn') {
                    handleAddTask();
                }
                if (e.target.id === 'save-goal-btn') {
                    handleAddGoal();
                }
                if (e.target.id === 'save-alert-btn') { // <-- NOVO
                    handleAddAlert();
                }
            });
        }
        
        // --- Fun√ß√µes de Manipula√ß√£o de Dados (CRUD) ---
        
        // --- CRUD de Alertas (NOVO) ---
        async function handleAddAlert() {
            const input = document.getElementById('alert-text');
            const text = input.value.trim();
            if (text && userId) { 
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/alerts`), {
                        text: text,
                        createdAt: new Date().toISOString()
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar alerta:", error);
                }
            }
        }
        
        async function handleDeleteAlert(alertId) {
             showConfirmationModal("Tem certeza que deseja excluir este alerta?", async () => {
                if (!userId) return;
                 try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/alerts`, alertId));
                    currentModal = 'settings'; // Mant√©m o modal de settings aberto
                    renderModal(); // Re-renderiza o modal
                } catch (error) {
                    console.error("Erro ao deletar alerta:", error);
                }
            });
        }
        // --- FIM CRUD Alertas ---

        async function handleAddRoutine() {
            const input = document.getElementById('routine-name');
            const name = input.value.trim();
            if (name && userId) { 
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/routines`), {
                        name: name,
                        createdAt: new Date().toISOString() // <-- IMPORTANTE para estat√≠sticas
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar rotina:", error);
                }
            } else if (!name) {
                console.warn("Nome da rotina est√° vazio.");
            } else if (!userId) {
                console.error("Usu√°rio n√£o autenticado. N√£o √© poss√≠vel salvar.");
            }
        }
        
        async function handleDeleteRoutine(routineId) {
            // Confirma√ß√£o j√° existe!
            showConfirmationModal("Tem certeza que deseja excluir esta rotina? Todo o hist√≥rico dela ser√° perdido.", async () => {
                if (!userId) return;
                try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/routines`, routineId));
                    
                    const historyQuery = query(collection(db, `${dbPathPrefix}/routineHistory`), where("routineId", "==", routineId));
                    const historySnapshot = await getDocs(historyQuery);
                    const batch = writeBatch(db);
                    historySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    console.log("Rotina e hist√≥rico deletados.");
                } catch (error) {
                    console.error("Erro ao deletar rotina:", error);
                }
            });
        }
        
        async function handleToggleRoutine(checkbox) {
            const { routineId, routineName, historyId } = checkbox.dataset;
            const isCompleted = checkbox.checked;

            if (!userId) return;

            try {
                const historyDocId = historyId || `${routineId}_${todayString}`;
                const historyDocRef = doc(db, `${dbPathPrefix}/routineHistory`, historyDocId);
                
                await setDoc(historyDocRef, {
                    routineId: routineId,
                    routineName: routineName,
                    date: todayString,
                    completed: isCompleted
                }, { merge: true }); 
                
            } catch (error) {
                console.error("Erro ao atualizar rotina:", error);
            }
        }
        
        async function handleSaveJournal() {
            const textarea = document.getElementById('journal-textarea');
            const text = textarea.value;
            if (userId) {
                try {
                    const journalDocRef = doc(db, `${dbPathPrefix}/journalEntries`, todayString);
                    await setDoc(journalDocRef, {
                        text: text,
                        lastUpdatedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    const btn = document.getElementById('save-journal-btn');
                    btn.innerText = 'Salvo!';
                    btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
                    btn.classList.remove('bg-sky-600', 'hover:bg-sky-700');
                    setTimeout(() => {
                        btn.innerText = 'Salvar Di√°rio';
                        btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                        btn.classList.add('bg-sky-600', 'hover:bg-sky-700');
                    }, 2000);
                    
                } catch (error) {
                    console.error("Erro ao salvar di√°rio:", error);
                }
            }
        }
        
        async function handleAddTask() {
            const name = document.getElementById('task-name').value.trim();
            const dateInput = document.getElementById('task-date');
            const timeInput = document.getElementById('task-time'); // <-- NOVO
            
            // Se 'selectedDate' (do calend√°rio) existir, use-o. Sen√£o, use o valor do input.
            const date = selectedDate || dateInput.value; 
            const time = timeInput.value || null; // Salva como null se vazio
            
            if (name && date && userId) {
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/tasks`), {
                        name: name,
                        date: date,
                        time: time, // <-- NOVO
                        notifiedAt: [], // <-- NOVO para lembretes
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar tarefa:", error);
                }
            }
        }
        
        // --- L√ìGICA DE TAREFA ATUALIZADA (v2.2.0) ---
        async function handleToggleTask(taskId, isCompleted) {
            if (!userId) return;
            
            try {
                const taskDocRef = doc(db, `${dbPathPrefix}/tasks`, taskId);
                await updateDoc(taskDocRef, {
                    completed: !isCompleted // Inverte o estado
                });
                
                // CORRE√á√ÉO v2.2.3: Recarrega o modal do dia para mostrar a mudan√ßa
                if (currentModal === 'taskDayView' || currentModal === 'taskReminder') {
                    currentModal = null;
                    renderModal();
                } else {
                    currentModal = null;
                    renderModal();
                }
                // O listener onSnapshot vai atualizar a UI principal
            } catch (error) {
                console.error("Erro ao (des)marcar tarefa:", error);
            }
        }
        
        async function handleDeleteTask(taskId) {
            if (!userId) return;
            
            showConfirmationModal("Tem certeza que deseja excluir esta tarefa?", async () => {
                try {
                    const taskDocRef = doc(db, `${dbPathPrefix}/tasks`, taskId);
                    await deleteDoc(taskDocRef);
                    
                    // CORRE√á√ÉO v2.2.3: Fecha o modal
                    currentModal = null;
                    renderModal();
                    // O listener onSnapshot vai atualizar a UI
                } catch (error) {
                    console.error("Erro ao excluir tarefa:", error);
                }
            });
        }
        
        async function handleAddGoal() {
            const input = document.getElementById('goal-name');
            const name = input.value.trim();
            if (name && userId) { 
                try {
                    await addDoc(collection(db, `${dbPathPrefix}/goals`), {
                        name: name,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null
                    });
                    currentModal = null;
                    renderModal();
                } catch (error) {
                    console.error("Erro ao adicionar objetivo:", error);
                }
            }
        }
        
        // --- L√ìGICA DE OBJETIVO ATUALIZADA (v2.2.1) ---
        async function handleCompleteGoal(checkbox) {
             const goalId = checkbox.dataset.id;
             const goalName = checkbox.dataset.name;
             
             // 1. Imediatamente desmarca a caixa
             checkbox.checked = false; 
             
             if (!userId) return;

             // 2. Pede confirma√ß√£o
             showConfirmationModal(`Tem certeza que deseja marcar "${goalName}" como conclu√≠do? Ele ser√° removido da lista de ativos.`, () => {
                 // 3. Se confirmado, chama a l√≥gica real
                 confirmCompleteGoalLogic(goalId);
             });
        }
        
        async function confirmCompleteGoalLogic(goalId) {
             try {
                const goalDocRef = doc(db, `${dbPathPrefix}/goals`, goalId);
                await updateDoc(goalDocRef, {
                    completed: true,
                    completedAt: new Date().toISOString()
                });
            } catch (error) {
                console.error("Erro ao completar objetivo:", error);
            }
        }
        
        async function handleDeleteGoal(goalId) {
            showConfirmationModal("Tem certeza que deseja excluir este objetivo?", async () => {
                if (!userId) return;
                 try {
                    await deleteDoc(doc(db, `${dbPathPrefix}/goals`, goalId));
                } catch (error) {
                    console.error("Erro ao deletar objetivo:", error);
                }
            });
        }
        
        // --- Fun√ß√µes Auxiliares (Modal de Confirma√ß√£o) ---
        
        // --- FUN√á√ÉO DE CONTAGEM REGRESSIVA (v2.3.1 - Corre√ß√£o) ---
        // *** ESTA √â A FUN√á√ÉO CORRIGIDA ***
        function getTaskCountdown(task) {
            const now = new Date();
            
            const [year, month, day] = task.date.split('-').map(Number);
            let taskTime = [0, 0]; // Default 00:00
            
            // --- CORRE√á√ÉO AQUI ---
            // Verifica se task.time existe e n√£o est√° vazio
            if (task.time && task.time.includes(':')) { 
                taskTime = task.time.split(':').map(Number); 
            }
            
            const taskDate = new Date(year, month - 1, day, taskTime[0], taskTime[1]);
            
            const diffMs = taskDate.getTime() - now.getTime();
            
            // Se j√° passou h√° mais de um dia, apenas "Atrasada"
            if (diffMs < -86400000) { // -24 horas
                 return { text: "Atrasada", color: "slate" };
            }
            // Se passou hoje
            if (diffMs < 0) {
                 return { text: "Atrasada", color: "rose" };
            }
            
            const diffHours = Math.ceil(diffMs / (1000 * 60 * 60)); // Horas restantes
            
            // L√ìGICA DE 12 HORAS
            if (diffHours <= 12) {
                return { text: `${diffHours} ${diffHours === 1 ? 'hora' : 'horas'}`, color: "rose" };
            }
            
            // L√ìGICA DE DIAS
            // Recalcula a diferen√ßa em dias a partir da *meia-noite de hoje*
            const diffDays = Math.ceil((new Date(year, month - 1, day).getTime() - todayDate.getTime()) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return { text: "Hoje", color: "rose" }; // Fallback para tarefas sem hora
            
            // --- CORRE√á√ÉO v2.3.5: Nova l√≥gica de cores ---
            if (diffDays <= 2) return { text: `${diffDays} ${diffDays === 1 ? 'dia' : 'dias'}`, color: "rose" };
            if (diffDays <= 4) return { text: `${diffDays} dias`, color: "orange" };
            return { text: `${diffDays} dias`, color: "emerald" };
        }
        
        // --- NOVA FUN√á√ÉO DE LEMBRETE (v2.6.0) ---
        function checkTaskReminders() {
            if (!allTasks || allTasks.length === 0 || currentModal !== null) {
                return; // N√£o faz nada se n√£o houver tarefas ou se um modal j√° estiver aberto
            }
            
            const now = new Date();
            
            for (const task of allTasks) {
                if (task.completed || !task.time) continue; // Ignora conclu√≠das ou sem hora

                const [year, month, day] = task.date.split('-').map(Number);
                const [hour, minute] = task.time.split(':').map(Number);
                const taskDate = new Date(year, month - 1, day, hour, minute);
                
                const diffMs = taskDate.getTime() - now.getTime();
                const minutesUntilDue = Math.ceil(diffMs / (1000 * 60));
                
                const notifiedAt = task.notifiedAt || [];

                // Define os n√≠veis de lembrete
                const reminderLevels = [60, 30, 15, 10];
                
                for (const level of reminderLevels) {
                    if (minutesUntilDue > 0 && minutesUntilDue <= level && !notifiedAt.includes(level)) {
                        console.log(`Disparando lembrete de ${level} min para: ${task.name}`);
                        taskForReminder = { ...task, level: level }; // Salva a tarefa para o modal
                        currentModal = 'taskReminder';
                        renderModal(); // Mostra o modal de lembrete
                        
                        // Marca este n√≠vel como notificado no DB
                        updateTaskNotified(task.id, level);
                        return; // S√≥ mostra um lembrete de cada vez
                    }
                }
            }
        }
        
        async function updateTaskNotified(taskId, level) {
             if (!userId) return;
             try {
                const taskDocRef = doc(db, `${dbPathPrefix}/tasks`, taskId);
                await updateDoc(taskDocRef, {
                    notifiedAt: arrayUnion(level) // Adiciona o n√≠vel ao array
                });
            } catch (error) {
                console.error("Erro ao atualizar 'notifiedAt' da tarefa:", error);
            }
        }


        function showConfirmationModal(message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            const confirmationId = 'modal-confirm-' + Date.now();
            
            const modalHtml = `
                <div id="${confirmationId}" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" data-action="close-confirm"></div>
                    <div class="bg-white dark:bg-slate-800 w-full max-w-sm p-6 rounded-2xl shadow-2xl z-10">
                        <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 mb-4">Confirmar A√ß√£o</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-6 text-lg">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button data-action="close-confirm" class="px-5 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button data-action="confirm-action" class="px-5 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 font-semibold transition-colors">
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
            
            const modalElement = document.getElementById(confirmationId);

            const handleConfirmationClick = (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                if (target.dataset.action === 'confirm-action') {
                    onConfirm();
                    modalElement.remove();
                }
                if (target.dataset.action === 'close-confirm') {
                    modalElement.remove();
                }
            };
            
            modalElement.addEventListener('click', handleConfirmationClick);
        }

    </script>

    <style>
        /* Estilo base */
        html.dark body {
            background-color: #0f172a; /* bg-slate-900 */
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Remove o spinner padr√£o de inputs[type=date/time] (opcional) */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        /* Cor do texto do input[type=date/time] no modo escuro */
        .dark input[type="date"],
        .dark input[type="time"] {
            color-scheme: dark;
        }

        /* Checkbox customizado */
        .form-checkbox {
            appearance: none;
            -webkit-appearance: none;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            border-width: 2px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        .form-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-position: center;
            background-repeat: no-repeat;
            background-size: 100% 100%;
        }
        .form-checkbox:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
             --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);
             box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
             --tw-ring-opacity: 0.5;
        }
    </style>
</head>
<body class="antialiased font-sans bg-slate-100 dark:bg-slate-900">

    <!-- Conte√∫do Principal -->
    <div class="min-h-screen">
        <!-- Header Principal -->
        <header id="main-header" class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-10 border-b border-slate-200 dark:border-slate-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- MUDAN√áA v2.4.3: Header Sim√©trico -->
                <div class="flex justify-between items-center h-20">
                    
                    <!-- Lado Esquerdo: Alerta (com largura fixa) -->
                    <div class="w-8 flex justify-start">
                        <i id="alert-icon" data-lucide="bell" class="w-6 h-6 text-rose-500 hidden animate-pulse"></i>
                    </div>
                    
                    <!-- T√≠tulo (Centralizado) -->
                    <div class="text-center">
                        <h1 id="header-title" class="text-2xl font-bold text-slate-900 dark:text-slate-100">Painel Principal</h1>
                    </div>
                    
                    <!-- Lado Direito: Rel√≥gio (com largura fixa) -->
                    <div class="w-8 flex justify-end">
                        <i id="task-clock-icon" data-lucide="clock" class="w-6 h-6 hidden"></i> 
                    </div>
                </div>
            </div>
        </header>

        <!-- Container da P√°gina -->
        <!-- pb-24 = padding-bottom para deixar espa√ßo para a tab bar -->
        <main id="app-container" class="pb-24">
            <!-- O conte√∫do da p√°gina √© renderizado aqui pelo JavaScript -->
            <!-- Loading Spinner inicial -->
             <div class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
            </div>
        </main>
    </div>
    
    <!-- Container do Modal -->
    <div id="modal-container">
        <!-- O modal √© renderizado aqui pelo JavaScript -->
    </div>
    
    <!-- NOVA BARRA DE NAVEGA√á√ÉO INFERIOR (TAB BAR) -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex justify-around items-center shadow-lg z-10">
         <!-- As abas s√£o renderizadas aqui pelo JavaScript (renderBottomNav) -->
    </nav>

</body>
</html>
